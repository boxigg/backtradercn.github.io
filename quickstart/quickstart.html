<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Quickstart &#8212; backtrader 1.9.69.122 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mycss-2016-12-25-2300.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="../_static/myjs-2016-12-25-2300.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Platform Concepts" href="../concepts.html" />
    <link rel="prev" title="Installation" href="../installation.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

 <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <!-- <a class="navbar-brand" href="../index.html"> -->
        <a class="navbar-brand" href="/">
          backtrader</a>
        <a href="../index.html">
	  <span class="navbar-text navbar-version pull-left"><b>1.9.69.122</b></span>
	</a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav navbar-right"> 
            
                <li><a href="/">Home</a></li>
                <li><a href="/features">Features</a></li>
                <li><a href="/docu">Docs</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="https://community.backtrader.com">Community</a></li>
            
            
	      
              
            
            
            
            
            
          </ul>

          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- backtrader-001 -->
      <ins class="adsbygoogle"
	   style="display:block"
	   data-ad-client="ca-pub-2694577446631179"
	   data-ad-slot="3977998265"
	   data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<div class="globaltoc">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-the-platform">Using the platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="#from-0-to-100-the-samples">From 0 to 100: the samples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-setup">Basic Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-cash">Setting the Cash</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-data-feed">Adding a Data Feed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#our-first-strategy">Our First Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-some-logic-to-the-strategy">Adding some Logic to the Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#do-not-only-buy-but-sell">Do not only buy … but SELL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-broker-says-show-me-the-money">The broker says: Show me the money!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customizing-the-strategy-parameters">Customizing the Strategy: Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-an-indicator">Adding an indicator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visual-inspection-plotting">Visual Inspection: Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#let-s-optimize">Let’s Optimize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Platform Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operating.html">Operating the platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cerebro.html">Cerebro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cerebro/cheat-on-open/cheat-on-open.html">Cheat On Open</a></li>
<li class="toctree-l1"><a class="reference internal" href="../strategy.html">Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sizers/sizers.html">Sizers - Smart Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/timers.html">Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order_target/order_target.html">Target Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../signal_strategy/signal_strategy.html">Strategy with Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../broker.html">Broker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../slippage/slippage.html">Slippage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filler.html">Fillers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order.html">Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/order-creation-execution.html">Order Management and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/oco/oco.html">OCO orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/trail/stoptrail.html">StopTrail(Limit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/bracket/bracket.html">Bracket Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/futurespot/future-vs-spot.html">Futures and Spot Compensation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed.html">Data Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed-develop-csv.html">CSV Data Feed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed-develop-general/datafeed-develop-general.html">Binary Datafeed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending-a-datafeed.html">Extending a Datafeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandas-datafeed/pandas-datafeed.html">Pandas DataFeed Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tradingcalendar/tradingcalendar.html">Trading Calendar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-resampling/data-resampling.html">Data Resampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-multitimeframe/data-multitimeframe.html">Data - Multiple Timeframes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-replay/data-replay.html">Data - Replay</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-rollover/rolling-futures-over.html">Rolling over Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../induse.html">Using Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talib/talib.html">TA-Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixing-timeframes/indicators-mixing-timeframes.html">Mixing Timeframes in Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inddev.html">Indicator Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observers-and-statistics/observers-and-statistics.html">Observers and Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observer-benchmark/benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/analyzers.html">Analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/pyfolio.html">PyFolio Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/pyfolio-integration/pyfolio-integration.html">Pyfolio Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writer.html">Writer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commission-schemes/commission-schemes.html">Commissions: Stocks vs Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending-commissions/commission-schemes-extended.html">Extending Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-defined-commissions/commission-schemes-subclassing.html">User Defined Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commission-credit.html">Commissions: Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../position.html">Position</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trade.html">Trade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/ranges/plotting-date-ranges.html">Plotting Date Ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/sameaxis/plot-sameaxis.html">Plotting on the same axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization-improvements.html">Optimization improvements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../automated-bt-run/automated-bt-run.html">Automating BackTesting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../memory-savings/memory-savings.html">Saving Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timemgmt.html">DateTime Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../live/live.html">Live Data Feeds and Live Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataautoref.html">Data Feeds Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datayahoo.html">Yahoo Data Feed Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indautoref.html">Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talibindautoref.html">TA-Lib Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../strategy-reference.html">Strategies Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers-reference.html">Analyzers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observers-reference.html">Observers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sizers-reference.html">Sizers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters-reference.html">Filters Reference</a></li>
</ul>

</div>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="quickstart">
<span id="id1"></span><h1>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h1>
<div class="section" id="using-the-platform">
<h2>Using the platform<a class="headerlink" href="#using-the-platform" title="Permalink to this headline">¶</a></h2>
<p>Let’s run through a series of examples (from almost an empty one to a fully
fledged strategy) but not without before roughly explaining 2 basic concepts
when working with <strong>backtrader</strong></p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Lines</p>
<p>Data Feeds, Indicators and Strategies have <em>lines</em>.</p>
<p>A line is a succession of points that when joined together form this
line. When talking about the markets, a Data Feed has usually the following
set of points per day:</p>
<blockquote>
<div><ul class="simple">
<li>Open, High, Low, Close, Volume, OpenInterest</li>
</ul>
</div></blockquote>
<p>The series of “Open”s along time is a Line. And therefore a Data Feed has
usually 6 lines.</p>
<p>If we also consider “DateTime” (which is the actual reference for a single
point), we could count 7 lines.</p>
</li>
<li><p class="first">Index 0 Approach</p>
<p>When accessing the values in a line, the current value is accessed with
index: <em>0</em></p>
<p>And the “last” output value is accessed with <em>-1</em>. This in line with Python
conventions for iterables (and a line can be iterated and is therefore an
iterable) where index <em>-1</em> is used to access the “last” item of the
iterable/array.</p>
<p>In our case is the last <strong>output</strong> value what’s getting accessed.</p>
<p>As such and being index <em>0</em> right after <em>-1</em>, it is used to access the
current moment in line.</p>
</li>
</ol>
</div></blockquote>
<p>With that in mind and if we imagine a Strategy featuring a Simple Moving
average created during initialization:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">SimpleMovingAverage</span><span class="p">(</span><span class="o">.....</span><span class="p">)</span>
</pre></div>
</div>
<p>The easiest and simplest way to access the current value of this moving average:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">av</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>There is no need to know how many bars/minutes/days/months have been processed,
because “0” uniquely identifies the current instant.</p>
<p>Following pythonic tradition, the “last” output value is accessed using <em>-1</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">previous_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Of course earlier output values can be accessed with -2, -3, …</p>
</div>
<div class="section" id="from-0-to-100-the-samples">
<h2>From 0 to 100: the samples<a class="headerlink" href="#from-0-to-100-the-samples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="basic-setup">
<h3>Basic Setup<a class="headerlink" href="#basic-setup" title="Permalink to this headline">¶</a></h3>
<p>Let’s get running.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">10000.00</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">10000.00</span>
</pre></div>
</div>
<p>In this example:</p>
<blockquote>
<div><ul class="simple">
<li>backtrader was imported</li>
<li>The Cerebro engine was instantiated</li>
<li>The resulting <em>cerebro</em> instance was told to <em>run</em> (loop over data)</li>
<li>And the resulting outcome was printed out</li>
</ul>
</div></blockquote>
<p>Although it doesn’t seem much, let’s point out something explicitly shown:</p>
<blockquote>
<div><ul class="simple">
<li>The Cerebro engine has created a <em>broker</em> instance in the background</li>
<li>The instance already has some cash to start with</li>
</ul>
</div></blockquote>
<p>This behind the scenes broker instantiation is a constant trait in the platform
to simplify the life of the user. If no broker is set by the user, a default one
is put in place.</p>
<p>And 10K monetary units is a usual value with some brokers to begin with.</p>
</div>
<div class="section" id="setting-the-cash">
<h3>Setting the Cash<a class="headerlink" href="#setting-the-cash" title="Permalink to this headline">¶</a></h3>
<p>In the world of finance, for sure only “losers” start with 10k. Let’s change the
cash and run the example again.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000000.00</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000000.00</span>
</pre></div>
</div>
<p>Mission accomplished. Let’s move to tempestuous waters.</p>
</div>
<div class="section" id="adding-a-data-feed">
<h3>Adding a Data Feed<a class="headerlink" href="#adding-a-data-feed" title="Permalink to this headline">¶</a></h3>
<p>Having cash is fun, but the purpose behind all this is to let an automated
strategy multiply the cash without moving a finger by operating on an asset
which we see as a <em>Data Feed</em></p>
<p>Ergo … No <em>Data Feed</em> -&gt; <strong>No Fun</strong>. Let’s add one to the ever growing
example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000000.00</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000000.00</span>
</pre></div>
</div>
<p>The amount of boilerplate has grown slightly, because we added:</p>
<blockquote>
<div><ul class="simple">
<li>Finding out where our example script is to be able to locate the sample
<em>Data Feed</em> file</li>
<li>Having <em>datetime</em> objects to filter on which data from the <em>Data Feed</em> we
will be operating</li>
</ul>
</div></blockquote>
<p>Aside from that, the <em>Data Feed</em> is created and added to <strong>cerebro</strong>.</p>
<p>The output has not changed and it would be a miracle if it had.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Yahoo Online sends the CSV data in date descending order, which is not
the standard convention. The <em>reversed=True</em> prameter takes into
account that the CSV data in the file has already been <strong>reversed</strong>
and has the standard expected date ascending order.</p>
</div>
</div>
<div class="section" id="our-first-strategy">
<h3>Our First Strategy<a class="headerlink" href="#our-first-strategy" title="Permalink to this headline">¶</a></h3>
<p>The cash is in the <em>broker</em> and the <em>Data Feed</em> is there. It seems like risky
business is just around the corner.</p>
<p>Let’s put a Strategy into the equation and print the “Close” price of each day
(bar).</p>
<p><strong>DataSeries</strong> (the underlying class in <em>Data Feeds</em>) objects have aliases to
access the well known OHLC (Open High Low Close) daily values. This should ease
up the creation of our printing logic.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function for this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.85</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
</pre></div>
</div>
<p>Someone said the stockmarket was risky business, but it doesn’t seem so.</p>
<p>Let’s explain some of the magic:</p>
<blockquote>
<div><ul>
<li><p class="first">Upon __init__ being called the strategy already has a list of datas that are
present in the platform</p>
<p>This is a standard Python <em>list</em> and datas can be accessed in the order they
were inserted.</p>
<p>The first data in the list <cite>self.datas[0]</cite> is the default data for trading
operations and to keep all strategy elements synchronized (<em>it’s the system
clock</em>)</p>
</li>
<li><p class="first"><cite>self.dataclose = self.datas[0].close</cite> keeps a reference to the <em>close
line</em>. Only one level of indirection is later needed to access the close
values.</p>
</li>
<li><p class="first">The strategy <cite>next</cite> method will be called on each bar of the system clock
(self.datas[0]). This is true until other things come into play like
<em>indicators</em>, which need some bars to start producing an output. More on
that later.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="adding-some-logic-to-the-strategy">
<h3>Adding some Logic to the Strategy<a class="headerlink" href="#adding-some-logic-to-the-strategy" title="Permalink to this headline">¶</a></h3>
<p>Let’s try some crazy idea we had by looking at some charts</p>
<blockquote>
<div><ul class="simple">
<li>If the price has been falling 3 sessions in a row … BUY BUY BUY!!!</li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># current close less than previous close</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="c1"># previous close less than the previous close</span>

                <span class="c1"># BUY, BUY, BUY!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.85</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">22.63</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">22.63</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.37</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">99725.08</span>
</pre></div>
</div>
<p>Several “BUY” creation orders were issued, our porftolio value was
decremented. A couple of important things are clearly missing.</p>
<blockquote>
<div><ul>
<li><p class="first">The order was created but it is unknown if it was executed, when and at what
price.</p>
<p>The next example will build upon that by listening to notifications of order
status.</p>
</li>
</ul>
</div></blockquote>
<p>The curious reader may ask how many shares are being bought, what asset is being
bought and how are orders being executed. Where possible (and in this case it is)
the platform fills in the gaps:</p>
<blockquote>
<div><ul class="simple">
<li>self.datas[0] (the main data aka system clock) is the target asset if no
other one is specified</li>
<li>The stake is provided behind the scenes by a <em>position sizer</em> which uses a
fixed stake, being the default “1”. It will be modified in a later example</li>
<li>The order is executed “At Market”. The broker (shown in previous examples)
executes this using the opening price of the next bar, because that’s the
1st tick after the current under examination bar.</li>
<li>The order is executed so far without any commission (more on that later)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="do-not-only-buy-but-sell">
<h3>Do not only buy … but SELL<a class="headerlink" href="#do-not-only-buy-but-sell" title="Permalink to this headline">¶</a></h3>
<p>After knowing how to enter the market (long), an “exit concept” is needed and
also understanding whether the strategy is in the market.</p>
<blockquote>
<div><ul class="simple">
<li>Luckily a Strategy object offers access to a <em>position</em> attribute for the
default <em>data feed</em></li>
<li>Methods <em>buy</em> and <em>sell</em> return the <strong>created</strong> (not yet executed) order</li>
<li>Changes in orders’ status will be notified to the strategy via a <em>notify</em>
method</li>
</ul>
</div></blockquote>
<p>The <em>“exit concept”</em> will be an easy one:</p>
<blockquote>
<div><ul>
<li><p class="first">Exit after 5 bars (on the 6th bar) have elapsed for good or for worse</p>
<p>Please notice that there is no “time” or “timeframe” implied: number of
bars. The bars can represent 1 minute, 1 hour, 1 day, 1 week or any other
time period.</p>
<p>Although we know the data source is a daily one, the strategy makes no
assumption about that.</p>
</li>
</ul>
</div></blockquote>
<p>Additionally and to simplify:</p>
<blockquote>
<div><ul class="simple">
<li>Do only allow a Buy order if not yet in the market</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>next</em> method gets no “bar index” passed and therefore it seems
obscure how to understand when 5 bars may have elapsed, but this has
been modeled in pythonic way: call <em>len</em> on an object and it will tell
you the length of its <em>lines</em>. Just write down (save in a variable) at
which length in an operation took place and see if the current length
is 5 bars away.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY EXECUTED, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">issell</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="c1"># Write down: no pending order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># current close less than previous close</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="c1"># previous close less than the previous close</span>

                        <span class="c1"># BUY, BUY, BUY!!! (with default parameters)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Already in the market ... we might sell</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">+</span> <span class="mi">5</span><span class="p">):</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.85</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="mf">23.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">22.63</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.37</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">26.49</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.77</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.77</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="mf">25.70</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.18</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.93</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="mf">28.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.18</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="mf">26.23</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100018.53</span>
</pre></div>
</div>
<p>Blistering Barnacles!!! The system made money … something must be wrong</p>
</div>
<div class="section" id="the-broker-says-show-me-the-money">
<h3>The broker says: Show me the money!<a class="headerlink" href="#the-broker-says-show-me-the-money" title="Permalink to this headline">¶</a></h3>
<p>And the money is called “commission”.</p>
<p>Let’s add a reasonable <em>0.1%</em> commision rate per operation (both for buying and
selling … yes the broker is avid …)</p>
<p>A single line will suffice for it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span> <span class="c1"># 0.1% ... divide by 100 to remove the %</span>
</pre></div>
</div>
<p>Being experienced with the platform we want to see the profit or loss after a
buy/sell cycle, with and without commission.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders and buy price/commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade</span><span class="o">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;OPERATION PROFIT, GROSS </span><span class="si">%.2f</span><span class="s1">, NET </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnlcomm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># current close less than previous close</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="c1"># previous close less than the previous close</span>

                        <span class="c1"># BUY, BUY, BUY!!! (with default parameters)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Already in the market ... we might sell</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">+</span> <span class="mi">5</span><span class="p">):</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Set the commission - 0.1% ... divide by 100 to remove the %</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.85</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">23.61</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">23.61</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.02</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">22.63</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.37</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">26.49</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.77</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.77</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">25.70</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">25.70</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.03</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">2.09</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.04</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.18</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.93</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">28.29</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">28.29</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.03</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">0.12</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.18</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">26.23</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">26.23</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.03</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100016.98</span>
</pre></div>
</div>
<p>God Save the Queen!!! The system still made money.</p>
<p>Before moving on, let’s notice something by filtering the “OPERATION PROFIT”
lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">2.09</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.04</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">07</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">3.68</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">3.63</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">4.48</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">4.42</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">3.48</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">3.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">0.41</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">0.49</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">07</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">2.45</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.37</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">1.95</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">2.02</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">5.46</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">5.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">11</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">3.74</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">3.81</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">1.46</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">1.53</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">1.62</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">1.69</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">14</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">2.08</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.01</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">0.07</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">4.36</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">4.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">0.95</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">4.26</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">4.34</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">1.29</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">1.22</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">13</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">2.98</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">3.04</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">3.01</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.95</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">3.59</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">3.65</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">16</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">1.28</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">1.23</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">01</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">2.59</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">2.54</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">0.12</span>
</pre></div>
</div>
<p>Adding up the “NET” profits the final figure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">15.83</span>
</pre></div>
</div>
<p>But the system said the following at the end:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100016.98</span>
</pre></div>
</div>
<p>And obviously <em>15.83</em> is not <em>16.98</em>. There is no error whatsoever. The “NET”
profit of <em>15.83</em> is already cash in the bag.</p>
<p>Unfortunately (or fortunately to better understand the platform) there is an
open position on the last day of the <em>Data Feed</em>. Even if a SELL operation has
been sent … IT HAS NOT YET BEEN EXECUTED.</p>
<p>The “Final Portfolio Value” calculated by the broker takes into account the
“Close” price on 2000-12-29. The actual execution price would have been set on
the next trading day which happened to be 2001-01-02. Extending the <em>Data Feed</em>”
to take into account this day the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">27.87</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">27.87</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.03</span>
<span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="mf">1.64</span><span class="p">,</span> <span class="n">NET</span> <span class="mf">1.59</span>
<span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.87</span>
<span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.87</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100017.41</span>
</pre></div>
</div>
<p>Now adding the previous NET profit to the completed operation’s net profit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">15.83</span> <span class="o">+</span> <span class="mf">1.59</span> <span class="o">=</span> <span class="mf">17.42</span>
</pre></div>
</div>
<p>Which (discarding rounding errors in the “print” statements) is the extra
Portfolio above the initial 100000 monetary units the strategy started with.</p>
</div>
<div class="section" id="customizing-the-strategy-parameters">
<h3>Customizing the Strategy: Parameters<a class="headerlink" href="#customizing-the-strategy-parameters" title="Permalink to this headline">¶</a></h3>
<p>It would a bit unpractical to hardcode some of the values in the strategy and
have no chance to change them easily. <em>Parameters</em> come in handy to help.</p>
<p>Definition of parameters is easy and looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;myparam&#39;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;exitbars&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),)</span>
</pre></div>
</div>
<p>Being this a standard Python tuple with some tuples inside it, the following may
look more appealling to some:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;myparam&#39;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;exitbars&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>With either formatting parametrization of the strategy is allowed when adding
the strategy to the Cerebro engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add a strategy</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">,</span> <span class="n">myparam</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">exitbars</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">setsizing</span></code> method below is deprecated. This content is kept
here for anyone looking at old samples of the sources. The sources
have been update to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cerebro.addsizer(bt.sizers.FixedSize, stake=10)``
</pre></div>
</div>
<p class="last">Please read the section about <em>sizers</em></p>
</div>
<p>Using the parameters in the strategy is easy, as they are stored in a “params”
attribute. If we for example want to set the stake fix, we can pass the stake
parameter to the <em>position sizer</em> like this durint __init__:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the sizer stake from the params</span>
<span class="bp">self</span><span class="o">.</span><span class="n">sizer</span><span class="o">.</span><span class="n">setsizing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">stake</span><span class="p">)</span>
</pre></div>
</div>
<p>We could have also called <em>buy</em> and <em>sell</em> with a <em>stake</em> parameter and
<em>self.params.stake</em> as the value.</p>
<p>The logic to exit gets modified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Already in the market ... we might sell</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">exitbars</span><span class="p">):</span>
</pre></div>
</div>
<p>With all this in mind the example evolves to look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;exitbars&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders and buy price/commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade</span><span class="o">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;OPERATION PROFIT, GROSS </span><span class="si">%.2f</span><span class="s1">, NET </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnlcomm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># current close less than previous close</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="c1"># previous close less than the previous close</span>

                        <span class="c1"># BUY, BUY, BUY!!! (with default parameters)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Already in the market ... we might sell</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">exitbars</span><span class="p">):</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">)</span>

    <span class="c1"># Add a FixedSize sizer according to the stake</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addsizer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">sizers</span><span class="o">.</span><span class="n">FixedSize</span><span class="p">,</span> <span class="n">stake</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Set the commission - 0.1% ... divide by 100 to remove the %</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.85</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.39</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.05</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">23.61</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">236.10</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.24</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">22.63</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">26.23</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">262.30</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.26</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">100169.80</span>
</pre></div>
</div>
<p>In order to see the difference, the print outputs have also been extended to
show the execution size.</p>
<p>Having multiplied the stake by 10, the obvious has happened: the profit and loss
has been multiplied by 10. Instead of <em>16.98</em>, the surplus is now <em>169.80</em></p>
</div>
<div class="section" id="adding-an-indicator">
<h3>Adding an indicator<a class="headerlink" href="#adding-an-indicator" title="Permalink to this headline">¶</a></h3>
<p>Having heard of <em>indicators</em>, the next thing anyone would add to the strategy is
one of them. For sure they must be much better than a simple <em>“3 lower closes”</em>
strategy.</p>
<p>Inspired in one of the examples from PyAlgoTrade a strategy using a Simple
Moving Average.</p>
<blockquote>
<div><ul class="simple">
<li>Buy “AtMarket” if the close is greater than the Average</li>
<li>If in the market, sell if the close is smaller than the Average</li>
<li>Only 1 active operation is allowed in the market</li>
</ul>
</div></blockquote>
<p>Most of the existing code can be kept in place. Let’s add the average during
__init__ and keep a reference to it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">MovingAverageSimple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maperiod</span><span class="p">)</span>
</pre></div>
</div>
<p>And of course the logic to enter and exit the market will rely on the Average
values. Look in the code for the logic.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The starting cash will be 1000 monetary units to be in line with the
PyAlgoTrade example and no commission will be applied</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;maperiod&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders and buy price/commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Add a MovingAverageSimple indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">SimpleMovingAverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maperiod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade</span><span class="o">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;OPERATION PROFIT, GROSS </span><span class="si">%.2f</span><span class="s1">, NET </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnlcomm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="c1"># BUY, BUY, BUY!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

    <span class="c1"># Add a FixedSize sizer according to the stake</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addsizer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">sizers</span><span class="o">.</span><span class="n">FixedSize</span><span class="p">,</span> <span class="n">stake</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Set the commission</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<p>Now, before skipping to the next section <strong>LOOK CAREFULLY</strong> to the first date
which is shown in the log:</p>
<blockquote>
<div><ul>
<li><p class="first">It’ no longer <em>2000-01-03</em>, the first trading day in the year 2K.</p>
<p>It’s 2000-01-24 … <em>Who has stolen my cheese?</em></p>
</li>
</ul>
</div></blockquote>
<p>The missing days are not missing. The platform has adapted to the new
circumstances:</p>
<blockquote>
<div><ul class="simple">
<li>An indicator (SimpleMovingAverage) has been added to the Strategy.</li>
<li>This indicator needs X bars to produce an output: in the example: 15</li>
<li>2000-01-24 is the day in which the 15th bar occurs</li>
</ul>
</div></blockquote>
<p>The <em>backtrader</em> platform assumes that the Strategy has the indicator in place
for a good reason, <strong>to use it in the decision making process</strong>. And it makes no
sense to try to make decisions if the indicator is not yet ready and producing
values.</p>
<blockquote>
<div><ul class="simple">
<li><em>next</em> will be 1st called when all indicators have already reached the
minimum needed period to produce a value</li>
<li>In the example there is a single indicator, but the strategy could have any
number of them.</li>
</ul>
</div></blockquote>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.55</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">25</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">26.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">25</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">26.76</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">267.60</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.96</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">24.43</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">24.43</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">24.28</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">242.80</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">24.80</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">24.80</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">22.34</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">23.55</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.46</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">25.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">02</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">25.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">26.11</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">261.10</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">26.88</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">26.23</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">262.30</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">OPERATION</span> <span class="n">PROFIT</span><span class="p">,</span> <span class="n">GROSS</span> <span class="o">-</span><span class="mf">20.60</span><span class="p">,</span> <span class="n">NET</span> <span class="o">-</span><span class="mf">20.60</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">28.65</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">286.50</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">973.90</span>
</pre></div>
</div>
<p>In the name of the King!!! A winning system turned into a losing one … and
that with no commission. It may well be that <strong>simply</strong> adding an <em>indicator</em> is
not the universal panacea.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The same logic and data with PyAlgoTrade yields a slightly different
result (slightly off). Looking at the entire printout reveals that
some operations are not exactly the same. Being the culprit again the
usual suspect: <em>rounding</em>.</p>
<p>PyAlgoTrade does not round the datafeed values when applying the
divided “adjusted close” to the data feed values.</p>
<p>The Yahoo Data Feed provided by <em>backtrader</em> rounds the values down
to 2 decimals after applying the adjusted close. Upon printing the
values everything seems the same, but it’s obvious that sometimes
that 5th place decimal plays a role.</p>
<p class="last">Rounding down to 2 decimals seems more realistic, because Market
Exchanges do only allow a number of decimals per asset (being that 2
decimals usually for stocks)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Yahoo Data Feed (starting with version <code class="docutils literal notranslate"><span class="pre">1.8.11.99</span></code> allows to
specify if rounding has to happen and how many decimals)</p>
</div>
</div>
<div class="section" id="visual-inspection-plotting">
<h3>Visual Inspection: Plotting<a class="headerlink" href="#visual-inspection-plotting" title="Permalink to this headline">¶</a></h3>
<p>A printout or log of the actual whereabouts of the system at each bar-instant is
good but humans tend to be <em>visual</em> and therefore it seems right to offer a view
of the same whereabouts as chart.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To plot you need to have <em>matplotlib</em> installed</p>
</div>
<p>Once again defaults for plotting are there to assist the platform user. Plotting
is incredibly a 1 line operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>Being the location for sure after <cite>cerebro.run()</cite> has been called.</p>
<p>In order to display the automatic plotting capabilities and a couple of easy
customizations, the following will be done:</p>
<blockquote>
<div><ul class="simple">
<li>A 2nd MovingAverage (Exponential) will be added. The defaults will plot it
(just like the 1st) with the data.</li>
<li>A 3rd MovingAverage (Weighted) will be added. Customized to plot in an own
plot (even if not sensible)</li>
<li>A Stochastic (Slow) will be added. No change to the defaults.</li>
<li>A MACD will be added. No change to the defaults.</li>
<li>A RSI will be added. No change to the defaults.</li>
<li>A MovingAverage (Simple) will be applied to the RSI. No change to the
defaults (it will be plotted with the RSI)</li>
<li>An AverageTrueRange will be added. Changed defaults to avoid it being
plotted.</li>
</ul>
</div></blockquote>
<p>The entire set of additions to the __init__ method of the Strategy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Indicators for the plotting show</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">WeightedMovingAverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">subplot</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">StochasticSlow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">MACDHisto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">rsi</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">SmoothedMovingAverage</span><span class="p">(</span><span class="n">rsi</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">ATR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Even if <em>indicators</em> are not explicitly added to a member variable of
the strategy (like self.sma = MovingAverageSimple…), they will
autoregister with the strategy and will influence the minimum period
for <em>next</em> and will be part of the plotting.</p>
<p class="last">In the example only <em>RSI</em> is added to a temporary variable <em>rsi</em> with
the only intention to create a MovingAverageSmoothed on it.</p>
</div>
<p>The example now:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>

<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;maperiod&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders and buy price/commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Add a MovingAverageSimple indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">SimpleMovingAverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maperiod</span><span class="p">)</span>

        <span class="c1"># Indicators for the plotting show</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">WeightedMovingAverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                            <span class="n">subplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">StochasticSlow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">MACDHisto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">SmoothedMovingAverage</span><span class="p">(</span><span class="n">rsi</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">ATR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="c1"># Write down: no pending order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade</span><span class="o">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;OPERATION PROFIT, GROSS </span><span class="si">%.2f</span><span class="s1">, NET </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnlcomm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="c1"># BUY, BUY, BUY!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">TestStrategy</span><span class="p">)</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

    <span class="c1"># Add a FixedSize sizer according to the stake</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addsizer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">sizers</span><span class="o">.</span><span class="n">FixedSize</span><span class="p">,</span> <span class="n">stake</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Set the commission</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Print out the starting conditions</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Starting Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Print out the final result</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final Portfolio Value: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="c1"># Plot the result</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>After the execution the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Starting</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">1000.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">18</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.61</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.97</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.97</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">23</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">28.38</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">283.80</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">23</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.73</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="o">...</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.82</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">BUY</span> <span class="n">EXECUTED</span><span class="p">,</span> <span class="n">Size</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Price</span><span class="p">:</span> <span class="mf">28.65</span><span class="p">,</span> <span class="n">Cost</span><span class="p">:</span> <span class="mf">286.50</span><span class="p">,</span> <span class="n">Commission</span> <span class="mf">0.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">30.06</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.17</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">28.94</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">29.29</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">Close</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">SELL</span> <span class="n">CREATE</span><span class="p">,</span> <span class="mf">27.41</span>
<span class="n">Final</span> <span class="n">Portfolio</span> <span class="n">Value</span><span class="p">:</span> <span class="mf">981.00</span>
</pre></div>
</div>
<dl class="docutils">
<dt><strong>The final result has changed even if the logic hasn’t</strong>. This is true but the</dt>
<dd>logic has not been applied to the same number of bars.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As explained before, the platform will first call next when all
indicators are ready to produce a value. In this plotting example
(very clear in the chart) the MACD is the last indicator to be fully
ready (all 3 lines producing an output). The 1st BUY order is no
longer scheduled during Jan 2000 but close to the end of Feb 2000.</p>
</div>
<p>The chart:</p>
<a class=""
               data-lightbox="group-642d21c4-3a56-4022-942a-87b6f1df76b0"
               href="../_images/quickstart101.png"
               title=""
               data-title=""
               ><img src="../_images/quickstart101.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a></div>
<div class="section" id="let-s-optimize">
<h3>Let’s Optimize<a class="headerlink" href="#let-s-optimize" title="Permalink to this headline">¶</a></h3>
<p>Many trading books say each market and each traded stock (or commodity or ..)
have different rythms. That there is no such thing as a one size fits all.</p>
<p>Before the plotting sample, when the strategy started using an indicator the
period default value was 15 bars. It’s a strategy parameter and this can be used
in an optimization to change the value of the parameter and see which one better
fits the market.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is plenty of literature about Optimization and associated pros
and cons. But the advice will always point in the same direction: do
not overoptimize. If a trading idea is not sound, optimizing may end
producing a positive result which is only valid for the backtested
dataset.</p>
</div>
<p>The sample is modified to optimize the period of the Simple Moving Average. For
the sake of clarity any output with regards to Buy/Sell orders has been removed</p>
<p>The example now:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># For datetime objects</span>
<span class="kn">import</span> <span class="nn">os.path</span>  <span class="c1"># To manage paths</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># To find out the script name (in argv[0])</span>


<span class="c1"># Import the backtrader platform</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="c1"># Create a Stratey</span>
<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;maperiod&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;printlog&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">printlog</span> <span class="ow">or</span> <span class="n">doprint</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep a reference to the &quot;close&quot; line in the data[0] dataseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>

        <span class="c1"># To keep track of pending orders and buy price/commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Add a MovingAverageSimple indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">SimpleMovingAverage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maperiod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="k">return</span>

        <span class="c1"># Check if an order has been completed</span>
        <span class="c1"># Attention: broker could reject order if not enough cash</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">buyprice</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buycomm</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bar_executed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Canceled</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Margin</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Rejected</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Order Canceled/Margin/Rejected&#39;</span><span class="p">)</span>

        <span class="c1"># Write down: no pending order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">notify_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trade</span><span class="o">.</span><span class="n">isclosed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;OPERATION PROFIT, GROSS </span><span class="si">%.2f</span><span class="s1">, NET </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnlcomm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simply log the closing price of the series from the reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Close, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Check if an order is pending ... if yes, we cannot send a 2nd one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>

            <span class="c1"># Not yet ... we MIGHT BUY if ...</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="c1"># BUY, BUY, BUY!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># SELL, SELL, SELL!!! (with all possible default parameters)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclose</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Keep track of the created order to avoid a 2nd order</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;(MA Period </span><span class="si">%2d</span><span class="s1">) Ending Value </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">maperiod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()),</span> <span class="n">doprint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Create a cerebro entity</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c1"># Add a strategy</span>
    <span class="n">strats</span> <span class="o">=</span> <span class="n">cerebro</span><span class="o">.</span><span class="n">optstrategy</span><span class="p">(</span>
        <span class="n">TestStrategy</span><span class="p">,</span>
        <span class="n">maperiod</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>

    <span class="c1"># Datas are in a subfolder of the samples. Need to find where the script is</span>
    <span class="c1"># because it could have been called from anywhere</span>
    <span class="n">modpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modpath</span><span class="p">,</span> <span class="s1">&#39;../../datas/orcl-1995-2014.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Create a Data Feed</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">YahooFinanceCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># Do not pass values before this date</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="c1"># Do not pass values after this date</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Add the Data Feed to Cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Set our desired cash start</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)</span>

    <span class="c1"># Add a FixedSize sizer according to the stake</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addsizer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">sizers</span><span class="o">.</span><span class="n">FixedSize</span><span class="p">,</span> <span class="n">stake</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Set the commission</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Run over everything</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Instead of calling <em>addstrategy</em> to add a stratey class to Cerebro, the call is
made to <em>optstrategy</em>. And instead of passing a value a range of values is
passed.</p>
<p>One of the “Strategy” hooks is added, the <em>stop</em> method, which will be called
when the data has been exhausted and backtesting is over. It’s used to print the
final net value of the portfolio in the broker (it was done in Cerebro
previously)</p>
<p>The system will execute the strategy for each value of the range. The following
will be output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">10</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">880.30</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">11</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">880.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">12</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">830.30</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">13</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">893.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">14</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">896.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">15</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">973.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">16</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">959.40</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">17</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">949.80</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">18</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1011.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">19</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1041.90</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">20</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1078.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">21</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1058.80</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">22</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1061.50</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">23</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1023.00</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">24</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1020.10</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">25</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">1013.30</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">26</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">998.30</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">27</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">982.20</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">28</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">975.70</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">29</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">983.30</span>
<span class="mi">2000</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">MA</span> <span class="n">Period</span> <span class="mi">30</span><span class="p">)</span> <span class="n">Ending</span> <span class="n">Value</span> <span class="mf">979.80</span>
</pre></div>
</div>
<p>Results:</p>
<blockquote>
<div><ul class="simple">
<li>For periods below 18 the strategy (commissionless) loses money.</li>
<li>For periods between 18 and 26 (both included) the strategy makes money.</li>
<li>Above 26 money is lost agagin.</li>
</ul>
</div></blockquote>
<p>And the winning period for this strategy and the given data set is:</p>
<blockquote>
<div><ul class="simple">
<li>20 bars, which wins 78.00 units over 1000 $/€ (a 7.8%)</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The extra indicators from the plotting example have been removed and
the start of operations is only influenced by the Simple Moving
Average which is being optimized. Hence the slightly different results
for period 15</p>
</div>
</div>
<div class="section" id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>The incremental samples have shown how to go from a barebones script to a fully
working trading system which even plots the results and can be optimized.</p>
<p>A lot more can be done to try to improve the chances of winning:</p>
<blockquote>
<div><ul>
<li><p class="first">Self defined Indicators</p>
<p>Creating an indicator is easy (and even plotting them is easy)</p>
</li>
<li><p class="first">Sizers</p>
<p>Money Management is for many the key to success</p>
</li>
<li><p class="first">Order Types (limit, stop, stoplimit)</p>
</li>
<li><p class="first">Some others</p>
</li>
</ul>
</div></blockquote>
<p>To ensure all the above items can be fully utilized the documentation provides
an insight into them (and other topics)</p>
<p>Look in the table of contents and keep on reading … and developing.</p>
<p>Best of luck</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, 2016, 2017, 2018 Daniel Rodriguez.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>