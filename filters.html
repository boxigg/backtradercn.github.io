<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Filters &#8212; backtrader 1.9.69.122 documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-3.3.6/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/mycss-2016-12-25-2300.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="_static/myjs-2016-12-25-2300.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Indicators" href="induse.html" />
    <link rel="prev" title="Rolling over Futures" href="data-rollover/rolling-futures-over.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

 <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <!-- <a class="navbar-brand" href="index.html"> -->
        <a class="navbar-brand" href="/">
          backtrader</a>
        <a href="index.html">
	  <span class="navbar-text navbar-version pull-left"><b>1.9.69.122</b></span>
	</a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav navbar-right"> 
            
                <li><a href="/">Home</a></li>
                <li><a href="/features">Features</a></li>
                <li><a href="/docu">Docs</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="https://community.backtrader.com">Community</a></li>
            
            
	      
              
            
            
            
            
            
          </ul>

          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- backtrader-001 -->
      <ins class="adsbygoogle"
	   style="display:block"
	   data-ad-client="ca-pub-2694577446631179"
	   data-ad-slot="3977998265"
	   data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<div class="globaltoc">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Platform Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="operating.html">Operating the platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cerebro.html">Cerebro</a></li>
<li class="toctree-l1"><a class="reference internal" href="cerebro/cheat-on-open/cheat-on-open.html">Cheat On Open</a></li>
<li class="toctree-l1"><a class="reference internal" href="strategy.html">Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="sizers/sizers.html">Sizers - Smart Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="timers/timers.html">Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="order_target/order_target.html">Target Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal_strategy/signal_strategy.html">Strategy with Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="broker.html">Broker</a></li>
<li class="toctree-l1"><a class="reference internal" href="slippage/slippage.html">Slippage</a></li>
<li class="toctree-l1"><a class="reference internal" href="filler.html">Fillers</a></li>
<li class="toctree-l1"><a class="reference internal" href="order.html">Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="order-creation-execution/order-creation-execution.html">Order Management and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="order-creation-execution/oco/oco.html">OCO orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="order-creation-execution/trail/stoptrail.html">StopTrail(Limit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="order-creation-execution/bracket/bracket.html">Bracket Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="order-creation-execution/futurespot/future-vs-spot.html">Futures and Spot Compensation</a></li>
<li class="toctree-l1"><a class="reference internal" href="datafeed.html">Data Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="datafeed-develop-csv.html">CSV Data Feed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="datafeed-develop-general/datafeed-develop-general.html">Binary Datafeed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending-a-datafeed.html">Extending a Datafeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="pandas-datafeed/pandas-datafeed.html">Pandas DataFeed Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="tradingcalendar/tradingcalendar.html">Trading Calendar</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-resampling/data-resampling.html">Data Resampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-multitimeframe/data-multitimeframe.html">Data - Multiple Timeframes</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-replay/data-replay.html">Data - Replay</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-rollover/rolling-futures-over.html">Rolling over Futures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Filters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l2"><a class="reference internal" href="#filters-at-work">Filters at work</a></li>
<li class="toctree-l2"><a class="reference internal" href="#filter-interface">Filter Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-sample-filter">A Sample Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-pseudo-api-for-filters">Data Pseudo-API for Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#another-example-pinkfish-filter">Another example: Pinkfish Filter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="induse.html">Using Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="talib/talib.html">TA-Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixing-timeframes/indicators-mixing-timeframes.html">Mixing Timeframes in Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="inddev.html">Indicator Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="observers-and-statistics/observers-and-statistics.html">Observers and Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="observer-benchmark/benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzers/analyzers.html">Analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzers/pyfolio.html">PyFolio Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzers/pyfolio-integration/pyfolio-integration.html">Pyfolio Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="writer.html">Writer</a></li>
<li class="toctree-l1"><a class="reference internal" href="commission-schemes/commission-schemes.html">Commissions: Stocks vs Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending-commissions/commission-schemes-extended.html">Extending Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-defined-commissions/commission-schemes-subclassing.html">User Defined Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="commission-credit.html">Commissions: Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="position.html">Position</a></li>
<li class="toctree-l1"><a class="reference internal" href="trade.html">Trade</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting/ranges/plotting-date-ranges.html">Plotting Date Ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting/sameaxis/plot-sameaxis.html">Plotting on the same axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization-improvements.html">Optimization improvements</a></li>
<li class="toctree-l1"><a class="reference internal" href="automated-bt-run/automated-bt-run.html">Automating BackTesting</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory-savings/memory-savings.html">Saving Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="timemgmt.html">DateTime Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="live/live.html">Live Data Feeds and Live Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataautoref.html">Data Feeds Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="datayahoo.html">Yahoo Data Feed Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="indautoref.html">Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="talibindautoref.html">TA-Lib Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="strategy-reference.html">Strategies Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzers-reference.html">Analyzers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="observers-reference.html">Observers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="sizers-reference.html">Sizers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="filters-reference.html">Filters Reference</a></li>
</ul>

</div>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="filters">
<h1>Filters<a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h1>
<p>This functionality is a relatively late addition to <em>backtrader</em> and had to be
fitted to the already existing internals. This makes it to be not as flexible
and 100% feature full as wished, but it can still serve the purpose in many
cases.</p>
<p>Although the implementation tried to allow plug and play filter chaining, the
pre-existing internals made it difficult to ensure that could always be
achieved. As such, some filters may be chained and some others may not.</p>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>Transform the values provided by a <em>data feed</em> to deliver a different <em>data
feed</em></li>
</ul>
</div></blockquote>
<p>The implementation was started to simplify the implementation of the two
obvious filters which can be directly used via the <em>cerebro</em> API. These are:</p>
<blockquote>
<div><ul>
<li><p class="first"><em>Resampling</em>  (<code class="docutils literal notranslate"><span class="pre">cerebro.resampledata</span></code>)</p>
<p>Here the filter transforms the <code class="docutils literal notranslate"><span class="pre">timeframe</span></code> and <code class="docutils literal notranslate"><span class="pre">compression</span></code> of the
incoming <em>data feed</em>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">Seconds</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Days</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>That means that the original data feed is delivery bars with a resolution
of <em>1 Second</em>. The <em>Resampling</em> filter intercepts the data and buffers it
until it can deliver a <em>1 Day</em> bar. This will happen when a <em>1 Second</em> bar
from the next day is seen.</p>
</li>
<li><p class="first"><em>Replaying</em> (<code class="docutils literal notranslate"><span class="pre">cerebro.replaydata</span></code>)</p>
<p>For the same timeframes as above, the filter would use the <em>1 Second</em>
resolution bars to rebuild the <em>1 Day</em> bar.</p>
<p>That means that the <em>1 Day</em> bar is delivered as many times as <em>1 Second</em>
bars are seen, updated to contain the latest information.</p>
<p>This simulates, for example, how an actual trading day has developed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the length of the data, <code class="docutils literal notranslate"><span class="pre">len(data)</span></code> and therefore the length of
the strategy remain unchanged as long as the <em>day</em> doesn’t
change.</p>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="filters-at-work">
<h2>Filters at work<a class="headerlink" href="#filters-at-work" title="Permalink to this headline">¶</a></h2>
<p>Given an existing data feed/source you use the <code class="docutils literal notranslate"><span class="pre">addfilter</span></code> method of the data
feed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">MyDataFeed</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="n">myname</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">addata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>And even if it happens to be compatible to the <em>resample/replay</em> filter the
following can also be done:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">MyDataFeed</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="n">myname</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">replaydata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="filter-interface">
<h2>Filter Interface<a class="headerlink" href="#filter-interface" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">filter</span></code> must conform to a given interface, being this:</p>
<blockquote>
<div><ul>
<li><p class="first">A callable which accepts this signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">callable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>or</p>
<ul>
<li><p class="first">A class which can be <em>instantiated</em> and <em>called</em></p>
<ul>
<li><p class="first">During instantiation the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method must support the signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method bears this signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The instance will be called for each new incoming values from the <em>data
feed</em>. The <code class="docutils literal notranslate"><span class="pre">*args</span></code> and <code class="docutils literal notranslate"><span class="pre">*kwargs</span></code> are the same passed to <code class="docutils literal notranslate"><span class="pre">__init__</span></code></p>
<p><strong>RETURN VALUES</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">True</span></code>: the inner data fetching loop of the data feed must retry
fetching data from the feed, becaue the length of the stream was
manipulated</li>
<li><code class="docutils literal notranslate"><span class="pre">False</span></code> even if data may have been edited (example: changed
<code class="docutils literal notranslate"><span class="pre">close</span></code> price), the length of the stream has remain untouched</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>In the case of a class based filter 2 additional methods can be implemented</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">last</span></code> with the following signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">last</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>This will be called when the <em>data feed</em> is over, allowing the filter to
deliver data it may have for example buffered. A typical case is
<em>resampling</em>, because a bar is buffered until data from the next time
period is seen. When the data feed is over, there is no new data to push
the buffered data out.</p>
<p><code class="docutils literal notranslate"><span class="pre">last</span></code> offers the chance to push the buffered data out.</p>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is obvious that if the <em>filter</em> supports no arguments at all and
will be added without any, the signatures can be simplified as in:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="a-sample-filter">
<h2>A Sample Filter<a class="headerlink" href="#a-sample-filter" title="Permalink to this headline">¶</a></h2>
<p>A very quick filter implementation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SessionFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionstart</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionend</span><span class="p">:</span>
            <span class="c1"># bar is in the session</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># tell outer data loop the bar can be processed</span>

        <span class="c1"># bar outside of the regular session times</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">()</span>  <span class="c1"># remove bar from data stack</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># tell outer data loop to fetch a new bar</span>
</pre></div>
</div>
<p>This filter:</p>
<blockquote>
<div><ul>
<li><p class="first">Uses <code class="docutils literal notranslate"><span class="pre">data.p.sessionstart</span></code> and <code class="docutils literal notranslate"><span class="pre">data.p.sessionend</span></code> (standard data feed
parameters) to decide if a bar is in the session.</p>
</li>
<li><p class="first">If <em>in-the-session</em> the return value is <code class="docutils literal notranslate"><span class="pre">False</span></code> to indicate nothing was
done and the processing of the current bar can continue</p>
</li>
<li><p class="first">If <em>not-in-the-session</em>, the bar is removed from the stream and <code class="docutils literal notranslate"><span class="pre">True</span></code> is
returned to indicate a new bar must be fetched.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the <code class="docutils literal notranslate"><span class="pre">data.backwards()</span></code> makes uses of the <code class="docutils literal notranslate"><span class="pre">LineBuffer</span></code>
interface. This digs deep into the internals of <em>backtrader</em>.</p>
</div>
</li>
</ul>
</div></blockquote>
<p>The use of this filter:</p>
<blockquote>
<div><ul class="simple">
<li>Some data feeds contain <em>out of regular trading hours</em> data, which may not
be of interest to the trader. With this filter only <em>in-session</em> bars will
be considered.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="data-pseudo-api-for-filters">
<h2>Data Pseudo-API for Filters<a class="headerlink" href="#data-pseudo-api-for-filters" title="Permalink to this headline">¶</a></h2>
<p>In the example above it has been shown how the filter invokes
<code class="docutils literal notranslate"><span class="pre">data.backwards()</span></code> to remove the current bar from the stream. Useful calls
from the data feed objects which are meant as a <em>pseudo-API for Filters</em> are:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">data.backwards(size=1,</span> <span class="pre">force=False)</span></code>: removes <em>size</em> bars from the data
stream (default is <code class="docutils literal notranslate"><span class="pre">1</span></code>) by moving the logical pointer backwards. If
<code class="docutils literal notranslate"><span class="pre">force=True</span></code>, then the physical storage is also removed.</p>
<p>Removing the physical storage is a delicate operation and is only meant as
a hack for internal operations.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">data.forward(value=float('NaN'),</span> <span class="pre">size=1)</span></code>: moves <em>size</em> bars the storage
forward, increasing the physical storage if needed be and fills with
<code class="docutils literal notranslate"><span class="pre">value</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">data._addtostack(bar,</span> <span class="pre">stash=False)</span></code>: adds <code class="docutils literal notranslate"><span class="pre">bar</span></code> to a stack for later
processing. <code class="docutils literal notranslate"><span class="pre">bar</span></code> is an iterable containing as many values as <code class="docutils literal notranslate"><span class="pre">lines</span></code>
has the data feed.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">stash=False</span></code> the bar added to the stack will be consumed immediately
by the system at the beginning of the next iteration.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">stash=True</span></code> the bar will undergo the entire loop processing including
potentially being reparsed by filters</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">data._save2stack(erase=False,</span> <span class="pre">force=False)</span></code>: saves the current data bar
to the stack for later processing. If <code class="docutils literal notranslate"><span class="pre">erase=True</span></code> then
<code class="docutils literal notranslate"><span class="pre">data.backwards</span></code> will be invoked and will receive the parameter <code class="docutils literal notranslate"><span class="pre">force</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">data._updatebar(bar,</span> <span class="pre">forward=False,</span> <span class="pre">ago=0)</span></code>: uses the values in the
iterable <code class="docutils literal notranslate"><span class="pre">bar</span></code> to overwrite the values in the data stream <code class="docutils literal notranslate"><span class="pre">ago</span></code>
positions. With the default <code class="docutils literal notranslate"><span class="pre">ago=0</span></code> the current bar will updated. With
<code class="docutils literal notranslate"><span class="pre">-1</span></code>, the previous one.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="another-example-pinkfish-filter">
<h2>Another example: Pinkfish Filter<a class="headerlink" href="#another-example-pinkfish-filter" title="Permalink to this headline">¶</a></h2>
<p>This is an example of a filter that can be chained, and is meant so, to another
filter, namely the <em>replay filter</em>. The <em>Pinkfish</em> name is from the library
which describes the idea in its main page: using daily data to execute
operations which would only be possible with intraday data.</p>
<p>To achieve the effect:</p>
<blockquote>
<div><ul>
<li><p class="first">A daily bar will be broken in 2 componentes: <code class="docutils literal notranslate"><span class="pre">OHL</span></code> and then <code class="docutils literal notranslate"><span class="pre">C</span></code>.</p>
</li>
<li><p class="first">Those 2 pieces are chained with <em>replay</em> to have the following happening in
the stream:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">With</span> <span class="n">Len</span> <span class="n">X</span>     <span class="o">-&gt;</span> <span class="n">OHL</span>
<span class="n">With</span> <span class="n">Len</span> <span class="n">X</span>     <span class="o">-&gt;</span> <span class="n">OHLC</span>
<span class="n">With</span> <span class="n">Len</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">OHL</span>
<span class="n">With</span> <span class="n">Len</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">OHLC</span>
<span class="n">With</span> <span class="n">Len</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">OHL</span>
<span class="n">With</span> <span class="n">Len</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">OHLC</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<p>Logic:</p>
<blockquote>
<div><ul class="simple">
<li>When an <code class="docutils literal notranslate"><span class="pre">OHLC</span></code> bar is received it is copied into an interable and broken
down to become:<ul>
<li>An <code class="docutils literal notranslate"><span class="pre">OHL</span></code> bar. Because this concept doesn’t actually exist the <em>closing</em>
price is replaced with the <em>opening</em> price to really form an <code class="docutils literal notranslate"><span class="pre">OHLO</span></code>
bar.</li>
<li>An <code class="docutils literal notranslate"><span class="pre">C</span></code> bar whic also doesn’t exist. The reality is that it will be
delivered like a tick <code class="docutils literal notranslate"><span class="pre">CCCC</span></code></li>
<li>The volume if distributed between the 2 parts</li>
<li>The current bar is removed from the stream</li>
<li>The <code class="docutils literal notranslate"><span class="pre">OHLO</span></code> part is put onto the stack for immediate processing</li>
<li>The <code class="docutils literal notranslate"><span class="pre">CCCC</span></code> part is put into the stash for processing in the next round</li>
<li>Because the stack has something for immediate processing the filter can
return <code class="docutils literal notranslate"><span class="pre">False</span></code> to indicate it.</li>
</ul>
</li>
</ul>
</div></blockquote>
<p>This filter works together with:</p>
<blockquote>
<div><ul class="simple">
<li>The <em>replay</em> filter which puts together the <code class="docutils literal notranslate"><span class="pre">OHLO</span></code> and <code class="docutils literal notranslate"><span class="pre">CCCC</span></code> parts to
finally deliver an <code class="docutils literal notranslate"><span class="pre">OHLC</span></code> bar.</li>
</ul>
</div></blockquote>
<p>The use case:</p>
<blockquote>
<div><ul class="simple">
<li>Seeing something like if the maximum today is the highest maximum in the
last 20 sessions an issuing a <code class="docutils literal notranslate"><span class="pre">Close</span></code> order which gets executed with the
2nd tick.</li>
</ul>
</div></blockquote>
<p>The code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DaySplitter_Close</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Splits a daily bar in two parts simulating 2 ticks which will be used to</span>
<span class="sd">    replay the data:</span>

<span class="sd">      - First tick: ``OHLX``</span>

<span class="sd">        The ``Close`` will be replaced by the *average* of ``Open``, ``High``</span>
<span class="sd">        and ``Low``</span>

<span class="sd">        The session opening time is used for this tick</span>

<span class="sd">      and</span>

<span class="sd">      - Second tick: ``CCCC``</span>

<span class="sd">        The ``Close`` price will be used for the four components of the price</span>

<span class="sd">        The session closing time is used for this tick</span>

<span class="sd">    The volume will be split amongst the 2 ticks using the parameters:</span>

<span class="sd">      - ``closevol`` (default: ``0.5``) The value indicate which percentage, in</span>
<span class="sd">        absolute terms from 0.0 to 1.0, has to be assigned to the *closing*</span>
<span class="sd">        tick. The rest will be assigned to the ``OHLX`` tick.</span>

<span class="sd">    **This filter is meant to be used together with** ``cerebro.replaydata``</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;closevol&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="c1"># 0 -&gt; 1 amount of volume to keep for close</span>
    <span class="p">)</span>

    <span class="c1"># replaying = True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Make a copy of the new bar and remove it from stream</span>
        <span class="n">datadt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>  <span class="c1"># keep the date</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">==</span> <span class="n">datadt</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># skip bars that come again in the filter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">=</span> <span class="n">datadt</span>  <span class="c1"># keep ref to last seen bar</span>

        <span class="c1"># Make a copy of current data for ohlbar</span>
        <span class="n">ohlbar</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">())]</span>
        <span class="n">closebar</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[:]</span>  <span class="c1"># Make a copy for the close</span>

        <span class="c1"># replace close price with o-h-l average</span>
        <span class="n">ohlprice</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span> <span class="o">=</span> <span class="n">ohlprice</span> <span class="o">/</span> <span class="mf">3.0</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span>  <span class="c1"># adjust volume</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vohl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vol</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">closevol</span><span class="p">))</span>

        <span class="n">oi</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span>  <span class="c1"># adjust open interst</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionstart</span><span class="p">)</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Ajust closebar to generate a single tick -&gt; close price</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span> <span class="o">=</span> <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">-</span> <span class="n">vohl</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="n">oi</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionend</span><span class="p">)</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Update stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># remove the copied bar from stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">ohlbar</span><span class="p">)</span>  <span class="c1"># add ohlbar to stack</span>
        <span class="c1"># Add 2nd part to stash to delay processing to next round</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">closebar</span><span class="p">,</span> <span class="n">stash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># initial tick can be further processed from stack</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, 2016, 2017, 2018 Daniel Rodriguez.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>