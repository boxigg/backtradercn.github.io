<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Interactive Brokers &#8212; backtrader 1.9.69.122 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-3.3.6/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mycss-2016-12-25-2300.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="../../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="../../_static/myjs-2016-12-25-2300.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Visual Chart" href="../vc/vc.html" />
    <link rel="prev" title="Live Data Feeds and Live Trading" href="../live.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

 <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <!-- <a class="navbar-brand" href="../../index.html"> -->
        <a class="navbar-brand" href="/">
          backtrader</a>
        <a href="../../index.html">
	  <span class="navbar-text navbar-version pull-left"><b>1.9.69.122</b></span>
	</a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav navbar-right"> 
            
                <li><a href="/">Home</a></li>
                <li><a href="/features">Features</a></li>
                <li><a href="/docu">Docs</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="https://community.backtrader.com">Community</a></li>
            
            
	      
              
            
            
            
            
            
          </ul>

          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- backtrader-001 -->
      <ins class="adsbygoogle"
	   style="display:block"
	   data-ad-client="ca-pub-2694577446631179"
	   data-ad-slot="3977998265"
	   data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<div class="globaltoc">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Platform Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operating.html">Operating the platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cerebro.html">Cerebro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cerebro/cheat-on-open/cheat-on-open.html">Cheat On Open</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../strategy.html">Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sizers/sizers.html">Sizers - Smart Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/timers.html">Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order_target/order_target.html">Target Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signal_strategy/signal_strategy.html">Strategy with Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../broker.html">Broker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slippage/slippage.html">Slippage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filler.html">Fillers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order.html">Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order-creation-execution/order-creation-execution.html">Order Management and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order-creation-execution/oco/oco.html">OCO orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order-creation-execution/trail/stoptrail.html">StopTrail(Limit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order-creation-execution/bracket/bracket.html">Bracket Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order-creation-execution/futurespot/future-vs-spot.html">Futures and Spot Compensation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datafeed.html">Data Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datafeed-develop-csv.html">CSV Data Feed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datafeed-develop-general/datafeed-develop-general.html">Binary Datafeed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending-a-datafeed.html">Extending a Datafeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pandas-datafeed/pandas-datafeed.html">Pandas DataFeed Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tradingcalendar/tradingcalendar.html">Trading Calendar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-resampling/data-resampling.html">Data Resampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-multitimeframe/data-multitimeframe.html">Data - Multiple Timeframes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-replay/data-replay.html">Data - Replay</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-rollover/rolling-futures-over.html">Rolling over Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters.html">Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../induse.html">Using Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../talib/talib.html">TA-Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mixing-timeframes/indicators-mixing-timeframes.html">Mixing Timeframes in Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inddev.html">Indicator Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observers-and-statistics/observers-and-statistics.html">Observers and Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observer-benchmark/benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzers/analyzers.html">Analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzers/pyfolio.html">PyFolio Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzers/pyfolio-integration/pyfolio-integration.html">Pyfolio Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../writer.html">Writer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../commission-schemes/commission-schemes.html">Commissions: Stocks vs Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending-commissions/commission-schemes-extended.html">Extending Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-defined-commissions/commission-schemes-subclassing.html">User Defined Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../commission-credit.html">Commissions: Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../position.html">Position</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trade.html">Trade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting/ranges/plotting-date-ranges.html">Plotting Date Ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting/sameaxis/plot-sameaxis.html">Plotting on the same axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimization-improvements.html">Optimization improvements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../automated-bt-run/automated-bt-run.html">Automating BackTesting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../memory-savings/memory-savings.html">Saving Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timemgmt.html">DateTime Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../live.html">Live Data Feeds and Live Trading</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Interactive Brokers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sample-code">Sample Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#store-model-vs-direct-model">Store Model vs Direct Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ibstore-the-store">IBStore - the store</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ibdata-feeds">IBData feeds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ibbroker-trading-live">IBBroker - Trading Live</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../vc/vc.html">Visual Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oanda/oanda.html">Oanda</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../dataautoref.html">Data Feeds Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datayahoo.html">Yahoo Data Feed Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indautoref.html">Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../talibindautoref.html">TA-Lib Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../strategy-reference.html">Strategies Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzers-reference.html">Analyzers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observers-reference.html">Observers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sizers-reference.html">Sizers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters-reference.html">Filters Reference</a></li>
</ul>

</div>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="interactive-brokers">
<h1>Interactive Brokers<a class="headerlink" href="#interactive-brokers" title="Permalink to this headline">¶</a></h1>
<p>The integration with Interactive Brokers supports both:</p>
<blockquote>
<div><ul class="simple">
<li><em>Live Data</em> feeding</li>
<li><em>Live Trading</em></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In spite of all attempts to test the maximum number of error conditions and
situations, the code could (like any other piece of software) contain bugs.</p>
<p class="last">Test any strategy thoroughly with a <strong>Paper Trading</strong> account or the TWS
<strong>Demo</strong> before going in production.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Interaction with Interactive Brokers is done by using the <code class="docutils literal notranslate"><span class="pre">IbPy</span></code> module
and this has to be installed prior to usage. There is no package in Pypi (at
the time of writing) but it can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span></code> with the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">blampe</span><span class="o">/</span><span class="n">IbPy</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">git</span></code> is not available in your system (Windows installation?) the
following should also work:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">blampe</span><span class="o">/</span><span class="n">IbPy</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</div>
<div class="section" id="sample-code">
<h2>Sample Code<a class="headerlink" href="#sample-code" title="Permalink to this headline">¶</a></h2>
<p>The sources contain a full sample under:</p>
<blockquote>
<div><ul class="simple">
<li>samples/ibtest/ibtest.py</li>
</ul>
</div></blockquote>
<p>The sample cannot cover every possible use case but it tries to provide broad
insight and should highlight that there is no real difference when it comes to
use the backtesting module or the live data module</p>
<p>One thing could be pin-pointed:</p>
<blockquote>
<div><ul>
<li><p class="first">The sample waits for a <code class="docutils literal notranslate"><span class="pre">data.LIVE</span></code> data status notification before any
trading activity takes place.</p>
<p>This would probably is something to consider in any live strategy</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="store-model-vs-direct-model">
<h2>Store Model vs Direct Model<a class="headerlink" href="#store-model-vs-direct-model" title="Permalink to this headline">¶</a></h2>
<p>Interaction with Interactive Brokers is supported through 2 models:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Store Model (<em>Preferred</em>)</li>
<li>Direct interaction with the data feed class and the broker class</li>
</ol>
</div></blockquote>
<p>The store model provides a clear separation pattern when it comes down to
creating <em>brokers</em> and <em>datas</em>. Two code snippets should serve better as an
example.</p>
<p>First with the <strong>Store</strong> model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="n">ibstore</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">stores</span><span class="o">.</span><span class="n">IBStore</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span> <span class="n">clientId</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;EUR.USD-CASH-IDEALPRO&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the parameters:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">host</span></code>, <code class="docutils literal notranslate"><span class="pre">port</span></code> and <code class="docutils literal notranslate"><span class="pre">clientId</span></code> are passed to where they belong the
<code class="docutils literal notranslate"><span class="pre">IBStore</span></code> which opens a connection using those parameters.</li>
</ul>
</div></blockquote>
<p>And then a <strong>data</strong> feed is created with <code class="docutils literal notranslate"><span class="pre">getdata</span></code> and a parameter common to
all data feeds in <em>backtrader*</em></p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dataname</span></code> whic requests the <em>EUR</em>/<em>USD</em> Forex pair.</li>
</ul>
</div></blockquote>
<p>And now with direct usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">IBData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;EUR.USD-CASH-IDEALPRO&#39;</span><span class="p">,</span>
                       <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span> <span class="n">clientId</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
</pre></div>
</div>
<p>Here:</p>
<blockquote>
<div><ul class="simple">
<li>Parameters intended for the store are passed to the data.</li>
<li>Those will be used to create a <code class="docutils literal notranslate"><span class="pre">IBStore</span></code> instance in the background</li>
</ul>
</div></blockquote>
<p>The drawback:</p>
<blockquote>
<div><ul class="simple">
<li>A lot less clarity, because it becomes unclear what belongs to the data and
what belongs to the store.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="ibstore-the-store">
<h2>IBStore - the store<a class="headerlink" href="#ibstore-the-store" title="Permalink to this headline">¶</a></h2>
<p>The store is the keystone of the live data feed/trade support, providing a
layer of adaptation between the <code class="docutils literal notranslate"><span class="pre">IbPy</span></code> module and the needs of a data feed
and a broker proxy.</p>
<p>A <em>Store</em> is a concept which covers the following functions:</p>
<blockquote>
<div><ul>
<li><p class="first">Being the central shop for an entity: in this case the entity is IB</p>
<p>Which may or may not require parameters</p>
</li>
<li><p class="first">Providing access to getting a <em>broker</em> instance with the method:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">IBStore.getbroker(*args,</span> <span class="pre">**kwargs)</span></code></li>
</ul>
</li>
<li><p class="first">Providing access to getter <em>data</em> feed instances</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">IBStore.getdata(*args,</span> <span class="pre">**kwargs)</span></code></p>
<p>In this case many of the <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> are common to data feeds like
<code class="docutils literal notranslate"><span class="pre">dataname</span></code>, <code class="docutils literal notranslate"><span class="pre">fromdate</span></code>, <code class="docutils literal notranslate"><span class="pre">todate</span></code>, <code class="docutils literal notranslate"><span class="pre">sessionstart</span></code>, <code class="docutils literal notranslate"><span class="pre">sessionend</span></code>,
<code class="docutils literal notranslate"><span class="pre">timeframe</span></code>, <code class="docutils literal notranslate"><span class="pre">compression</span></code></p>
<p>The data may provide other params. Check the reference below.</p>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">IBStore</span></code> provides:</p>
<blockquote>
<div><ul>
<li><p class="first">Connectivity target (<code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code> parameters)</p>
</li>
<li><p class="first">Identification (<code class="docutils literal notranslate"><span class="pre">clientId</span></code> parameter)</p>
</li>
<li><p class="first">Re-connectivity control (<code class="docutils literal notranslate"><span class="pre">reconnect</span></code> and <code class="docutils literal notranslate"><span class="pre">timeout</span></code> parameters)</p>
</li>
<li><p class="first">Time offset check (<code class="docutils literal notranslate"><span class="pre">timeoffset</span></code> parameters, see below)</p>
</li>
<li><p class="first">Notification and debugging</p>
<p><code class="docutils literal notranslate"><span class="pre">notifyall</span></code> (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>): in this case any <code class="docutils literal notranslate"><span class="pre">error</span></code> message (many
are simply informative) sent by IB will be relayed to <em>Cerebro</em>/<em>Strategy</em></p>
<p><code class="docutils literal notranslate"><span class="pre">_debug</span></code> (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>): in this case each and every message
received from TWS will be print out to standard outpu</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="ibdata-feeds">
<h2>IBData feeds<a class="headerlink" href="#ibdata-feeds" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-options">
<h3>Data Options<a class="headerlink" href="#data-options" title="Permalink to this headline">¶</a></h3>
<p>Be it directly or over <code class="docutils literal notranslate"><span class="pre">getdata</span></code> the <code class="docutils literal notranslate"><span class="pre">IBData</span></code> feed supports the following
data options:</p>
<blockquote>
<div><ul>
<li><p class="first">Historical download requests</p>
<p>These will be split over multiple requests if the duration exceeds the
limits imposed by IB for a given <em>timeframe/compression</em> combination</p>
</li>
<li><p class="first">RealTime Data in 3 flavors</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tickPrice</span></code> events (via IB <code class="docutils literal notranslate"><span class="pre">reqMktData</span></code>)</p>
<p>Used for <em>CASH</em> products (experimentation with at least TWS API 9.70 has
shown no support for the other types)</p>
<p>Receives a <em>tick</em> price event by looking at the <code class="docutils literal notranslate"><span class="pre">BID</span></code> prices, which
according to the non-official Internet literature seems to be the way to
track the <code class="docutils literal notranslate"><span class="pre">CASH</span></code> market prices.</p>
<p>Timestamps are generated locally in the system. An offset to the IB
Server time can be used if wished by the end user (calculated from IB <code class="docutils literal notranslate"><span class="pre">reqCurrentTime</span></code>)</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tickString</span></code> events (aka <code class="docutils literal notranslate"><span class="pre">RTVolume</span></code> (via IB <code class="docutils literal notranslate"><span class="pre">reqMktData</span></code>)</p>
<p>Receives a <em>OHLC/Volume</em> snapshot from IB approx. every 250ms (or greater
if no trading has happened)</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code> events (via IB <code class="docutils literal notranslate"><span class="pre">reqRealTimeBars</span></code>)</p>
<p>Receives historical 5 seconds bars (duration fixed by IB) every 5 seconds</p>
<p>If the chosen <em>timeframe/combination</em> is below the level <em>Seconds/5</em> this
feature will be automatically disabled.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code> do not work with the TWS Demo</p>
</div>
</li>
</ul>
<p>The default behavior is to use: <code class="docutils literal notranslate"><span class="pre">tickString</span></code> in most cases unless the
user specifically wants to use <code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Backfilling</span></code></p>
<p>Unless the user requests to just do a <em>historical</em> download, the data feed
will automatically backfill:</p>
<blockquote>
<div><ul class="simple">
<li><strong>At the start</strong>: with the maximum possible duration. Example: for a
<em>Days/1</em> (<em>timeframe/compression</em>) combination the maximum default
duration at IB is <em>1 year</em> and this is the amount of time that will be
backfilled</li>
<li><strong>After a data disconnection</strong>: in this case the amount of data
downloaded for the backfilling operation will be reduced to the minimum
by looking at the latest data received before the disconnection.</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Take into account that the final <em>timeframe/compression</em> combination taken
into account may not be the one specified during <em>data feed creation</em> but
during <em>insertion</em> in the system. See the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;EUR.USD-CASH-IDEALPRO&#39;</span><span class="p">,</span>
                       <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Minutes</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">As should now be clear, the final <em>timeframe/compression</em> combination taken
into account is <em>Minutes/2</em></p>
</div>
</div>
<div class="section" id="data-contract-check">
<h3>Data Contract Check<a class="headerlink" href="#data-contract-check" title="Permalink to this headline">¶</a></h3>
<p>During the start phase, the <em>data</em> feed will try to download the details of the
specified contract (see the reference for how to specify it). If no such
contract is found or multiple matches are found, the data will refuse to carry
on and will notify it to the system. Some examples.</p>
<p>Simple but unambiguous contract specification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;TWTR&#39;</span><span class="p">)</span>  <span class="c1"># Twitter</span>
</pre></div>
</div>
<p>Only one instance will be found (2016-06) because for the default type,
<code class="docutils literal notranslate"><span class="pre">STK</span></code>, exchange <code class="docutils literal notranslate"><span class="pre">SMART</span></code> and currency (the default is none) a single
contract trading in <code class="docutils literal notranslate"><span class="pre">USD</span></code> will be found.</p>
<p>A similar approach will fail with <code class="docutils literal notranslate"><span class="pre">AAPL</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>  <span class="c1"># Error -&gt; multiple contracts</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">SMART</span></code> finds contracts in several real exchanges and <code class="docutils literal notranslate"><span class="pre">AAPL</span></code> trades
in different currencies in some of them. The following is ok:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;AAPL-STK-SMART-USD&#39;</span><span class="p">)</span>  <span class="c1"># 1 contract found</span>
</pre></div>
</div>
</div>
<div class="section" id="data-notifications">
<h3>Data Notifications<a class="headerlink" href="#data-notifications" title="Permalink to this headline">¶</a></h3>
<p>The data feed will report the current status via one or more of the following
(check the <em>Cerebro</em> and <em>Strategy</em> reference)</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Cerebro.notify_data</span></code> (if overriden)n</li>
<li>A callback addded with <code class="docutils literal notranslate"><span class="pre">Cerebro.adddatacb</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Strategy.notify_data</span></code> (if overriden)</li>
</ul>
</div></blockquote>
<p>An example inside the <em>strategy</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IBStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">notify_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">LIVE</span><span class="p">:</span>  <span class="c1"># the data has switched to live data</span>
           <span class="c1"># do something</span>
           <span class="k">pass</span>
</pre></div>
</div>
<p>The following notifications will be sent following changes in the system:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">CONNECTED</span></code></p>
<p>Sent on successful initial connection</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">DISCONNECTED</span></code></p>
<p>In this case retrieving the data is no longer possible and the data will
indicate the system nothing can be done. Possible conditions:</p>
<blockquote>
<div><ul class="simple">
<li>Wrong contract specified</li>
<li>Interruption during historical download</li>
<li>Number of reconnection attempts to TWS exceeded</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">CONNBROKEN</span></code></p>
<p>Connectivity has been lost to either TWS or to the data farms. The data
feed will try (via the store) to reconnect and backfill, when needed, and
resume operations</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">NOTSUBSCRIBED</span></code></p>
<p>Contract and connection are ok, but the data cannot be retrieved due to
lack of permissions.</p>
<p>The data will indicate to the system that it cannot retrieve the data</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">DELAYED</span></code></p>
<p>Signaled to indicate that a <em>historical</em>/<em>backfilling</em> operation are in
progress and the data being processed by the strategy is not real-time data</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">LIVE</span></code></p>
<p>Signaled to indicate that the data to be processed from this point onwards
by the <em>strategy</em> is real-time data</p>
</li>
</ul>
</div></blockquote>
<p>Developers of <em>strategies</em> should consider which actions to undertake in cases
like when a disconnection takes place or when receiving <strong>delayed</strong> data.</p>
</div>
<div class="section" id="data-timeframes-and-compressions">
<h3>Data TimeFrames and Compressions<a class="headerlink" href="#data-timeframes-and-compressions" title="Permalink to this headline">¶</a></h3>
<p>Data feeds in the <em>backtrader</em> ecosystem, support the <code class="docutils literal notranslate"><span class="pre">timeframe</span></code> and
<code class="docutils literal notranslate"><span class="pre">compression</span></code> parameters during creation. These
parameters are also accessible as attributes with <code class="docutils literal notranslate"><span class="pre">data._timeframe</span></code> and
<code class="docutils literal notranslate"><span class="pre">data._compression</span></code></p>
<p>The significance of <em>timeframe/compression</em> combinations has a specific purpose
whenpassing the data to a <code class="docutils literal notranslate"><span class="pre">cerebro</span></code> instance via <code class="docutils literal notranslate"><span class="pre">resampledata</span></code> or
<code class="docutils literal notranslate"><span class="pre">replaydata</span></code>, to let the internal resampler/replayer objects to understand
what the intended target is.  <code class="docutils literal notranslate"><span class="pre">._timeframe</span></code> and <code class="docutils literal notranslate"><span class="pre">._compression</span></code> will be
overwritten in the data when resampled/replayed.</p>
<p>But in live data feeds on the other hand this information can play an important
role. See the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;EUR.USD-CASH-IDEALPRO&#39;</span><span class="p">,</span>
                       <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Ticks</span><span class="p">,</span>
                       <span class="n">compression</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># 1 is the default</span>
                       <span class="n">rtbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># use RealTimeBars</span>
                      <span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The user is requesting <strong>tick</strong> data and this important because:</p>
<blockquote>
<div><ul class="simple">
<li>No backfilling will take place (the minimum unit supported by IB is
<em>Seconds/1</em>)</li>
<li>Even if <code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code> are requested and supported by the <code class="docutils literal notranslate"><span class="pre">dataname</span></code>,
they will not be used because the minimum resolution of a <code class="docutils literal notranslate"><span class="pre">RealTimeBar</span></code>
is <em>Seconds/5</em></li>
</ul>
</div></blockquote>
<p>In any case and unless working with a resolution of <em>Ticks/1</em>, the data has to
be <em>resampled/replayed</em>. The case above with realtimebars and working:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;TWTR-STK-SMART&#39;</span><span class="p">,</span> <span class="n">rtbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case and as explained above, the <code class="docutils literal notranslate"><span class="pre">._timeframe</span></code> and <code class="docutils literal notranslate"><span class="pre">._compression</span></code>
attributes of the data will be overwritten during <code class="docutils literal notranslate"><span class="pre">resampledata</span></code>. This is
what will happen:</p>
<blockquote>
<div><ul class="simple">
<li><em>backfilling</em> will happen requesting a resolution of <em>Seconds/20</em></li>
<li><code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code> will be used for real-time data because the resolution is
equal/greater than <em>Seconds/5</em> and the data supports is (is no <em>CASH</em>
product)</li>
<li>Events to the system from TWS will happen at most every 5 seconds. This is
possibly not important because the system will only send a bar to the
strategy every 20 seconds.</li>
</ul>
</div></blockquote>
<p>The same without <code class="docutils literal notranslate"><span class="pre">RealTimeBars</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;TWTR-STK-SMART&#39;</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case:</p>
<blockquote>
<div><ul class="simple">
<li><em>backfilling</em> will happen requesting a resolution of <em>Seconds/20</em></li>
<li><code class="docutils literal notranslate"><span class="pre">tickString</span></code> will be used for real-time data because (is no <em>CASH</em> product)</li>
<li>Events to the system from TWS will happen every at most every 250ms. This
is possibly not important because the system will only send a bar to the
strategy every 20 seconds.</li>
</ul>
</div></blockquote>
<p>Finally with a <em>CASH</em> product and up to 20 seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;EUR.USD-CASH-IDEALPRO&#39;</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case:</p>
<blockquote>
<div><ul>
<li><p class="first"><em>backfilling</em> will happen requesting a resolution of <em>Seconds/20</em></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">tickPrice</span></code> will be used for real-time data because this is a cash
product</p>
<p>Even if <code class="docutils literal notranslate"><span class="pre">rtbar=True</span></code> is added</p>
</li>
<li><p class="first">Events to the system from TWS will happen at most every 250ms. This is
possibly not important because the system will only send a bar to the
strategy every 20 seconds.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="time-management">
<h3>Time Management<a class="headerlink" href="#time-management" title="Permalink to this headline">¶</a></h3>
<p>The data feed will automatically determine the timezone from the
<code class="docutils literal notranslate"><span class="pre">ContractDetails</span></code> object reported by <em>TWS</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This requires that <code class="docutils literal notranslate"><span class="pre">pytz</span></code> be installed. If not installed the user should
supply with the <code class="docutils literal notranslate"><span class="pre">tz</span></code> parameter to the data source a <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> compatible
instance for the desired output timezone</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If <code class="docutils literal notranslate"><span class="pre">pytz</span></code> is installed and the user feels the automatic timezone
determination is not working, the <code class="docutils literal notranslate"><span class="pre">tz</span></code> parameter can contain a string with
the name of the timezone. <code class="docutils literal notranslate"><span class="pre">backtrader</span></code> will try to instantiate a
<code class="docutils literal notranslate"><span class="pre">pytz.timezone</span></code> with the given name</p>
</div>
<p>The reported <code class="docutils literal notranslate"><span class="pre">datetime</span></code> will be that of the timezone related to the
product. Some examples:</p>
<blockquote>
<div><ul>
<li><p class="first"><em>Product</em>: EuroStoxxx 50 in the Eurex (ticker: <em>ESTX50-YYYYMM-DTB</em>)</p>
<p>The timezone will be <code class="docutils literal notranslate"><span class="pre">CET</span></code> (<em>Central European Time</em>) aka
<code class="docutils literal notranslate"><span class="pre">Europe/Berlin</span></code></p>
</li>
<li><p class="first"><em>Product</em>: ES-Mini (ticker: <em>ES-YYYYMM-GLOBEX</em>)</p>
<p>The timezone will be <code class="docutils literal notranslate"><span class="pre">EST5EDT</span></code> aka <code class="docutils literal notranslate"><span class="pre">EST</span></code> aka <code class="docutils literal notranslate"><span class="pre">US/Eastern</span></code></p>
</li>
<li><p class="first"><em>Product</em>: EUR.JPY forex pair (ticker <em>EUR.JPY-CASH-IDEALPRO</em>)</p>
<p>The timezone will be <code class="docutils literal notranslate"><span class="pre">EST5EDT</span></code> aka <code class="docutils literal notranslate"><span class="pre">EST</span></code> aka <code class="docutils literal notranslate"><span class="pre">US/Eastern</span></code></p>
<p>Actually this is an Interactive Brokers setting, because Forex pairs trade
almost 24 hours without interruption and as such there wouldn’t be a real
timezone for them.</p>
</li>
</ul>
</div></blockquote>
<p>This behavior makes sure that trading remains consistent regardless of the
actual location of the trader, given that the computer will most likely have
the actual location timezone and not the timezone of the trading venue.</p>
<p>Please read the <strong>Time Management</strong> section of the manual.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The TWS Demo is not accurate at reporting timezones for assets for
which no data download permissions are available (The EuroStoxx 50
future is an example of those cases)</p>
</div>
</div>
<div class="section" id="live-feeds-and-resampling-replaying">
<h3>Live Feeds and Resampling/Replaying<a class="headerlink" href="#live-feeds-and-resampling-replaying" title="Permalink to this headline">¶</a></h3>
<p>A design decision with regards to when to deliver bars for live feeds is:</p>
<blockquote>
<div><ul class="simple">
<li><em>Deliver them as much in real-time as possible</em></li>
</ul>
</div></blockquote>
<p>This may seem obvious and it is the case for a timeframe of <code class="docutils literal notranslate"><span class="pre">Ticks</span></code>, but if
<em>Resampling/Replaying</em> play a role, delays can take place. Use case:</p>
<blockquote>
<div><ul>
<li><p class="first">Resampling is configured to <em>Seconds/5</em> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">A tick with time <code class="docutils literal notranslate"><span class="pre">23:05:27.325000</span></code> is delivered</p>
</li>
<li><p class="first">Trading in the market is slow and the next tick is delivered at
<code class="docutils literal notranslate"><span class="pre">23:05:59.025000</span></code></p>
</li>
</ul>
</div></blockquote>
<p>It may not seem obvious but <em>backtrader</em> doesn’t know that trading is very slow
and the next tick will come in around <code class="docutils literal notranslate"><span class="pre">32</span></code> seconds later. With no provisions
in place a resampled bar with time <code class="docutils literal notranslate"><span class="pre">23:05:30.000000</span></code> would be delivered
around <code class="docutils literal notranslate"><span class="pre">29</span> <span class="pre">seconds</span></code> too late.</p>
<p>That’s why the live feed wakes up every <code class="docutils literal notranslate"><span class="pre">x</span></code> seconds (<em>float</em> value) to go to
the <em>Resampler/Replayer</em> and let it know that no new data has come in. This is
controlled with the parameter <code class="docutils literal notranslate"><span class="pre">qcheck</span></code> (default value: <code class="docutils literal notranslate"><span class="pre">0.5</span></code> seconds) when
creating a live data feed.</p>
<p>That means that the resampler has a chance every <code class="docutils literal notranslate"><span class="pre">qcheck</span></code> seconds to deliver
a bar if the local clock says, the resampling period is over. With this in
place, the resampled bar for the scenario above (<code class="docutils literal notranslate"><span class="pre">23:05:30.000000</span></code>) would be
delivered at most <code class="docutils literal notranslate"><span class="pre">qcheck</span></code> seconds after the reported time.</p>
<p>Because the default valus is <code class="docutils literal notranslate"><span class="pre">0.5</span></code> the latest time would be:
<code class="docutils literal notranslate"><span class="pre">23:05:30.500000</span></code>. That is almost 29 seconds earlier as before.</p>
<p>The drawback:</p>
<blockquote>
<div><ul class="simple">
<li><em>Some ticks may come in too late for the already delivered
resampled/replayed bar</em></li>
</ul>
</div></blockquote>
<p>If after delivering, TWS gets a late message from the server with a timestamp
of <code class="docutils literal notranslate"><span class="pre">23:05:29.995`000</span></code>, this is simply too late for the already reported time to
the system of <code class="docutils literal notranslate"><span class="pre">23:05.30.000000</span></code></p>
<p>This happens mostly if:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">timeoffset</span></code> <em>is disabled (set to ``False``) in ``IBStore`` and the time
difference between the *IB</em> reported time and the local clock is
significant.</li>
</ul>
</div></blockquote>
<p>The best approach to avoid most of those late samples:</p>
<blockquote>
<div><ul>
<li><p class="first">Increase the <code class="docutils literal notranslate"><span class="pre">qcheck</span></code> value, to allow for late messages to be taken into
account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;TWTR&#39;</span><span class="p">,</span> <span class="n">qcheck</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<p>This should add extra room, even if it delays the delivery of the
<em>resampled/replayed</em> bar</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course a delay of 2.0 seconds has a different significance for a
resampling of <em>Seconds/5</em> than for a resampling of <em>Minutes/10</em></p>
</div>
<p>If for whatever reason the end-user wishes to disable <code class="docutils literal notranslate"><span class="pre">timeoffset</span></code> and not
manage via <code class="docutils literal notranslate"><span class="pre">qcheck</span></code>, the late samples can still be taken:</p>
<blockquote>
<div><ul>
<li><p class="first">Use <code class="docutils literal notranslate"><span class="pre">_latethrough</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code> as a parameter to <code class="docutils literal notranslate"><span class="pre">getdata</span></code> /
<code class="docutils literal notranslate"><span class="pre">IBData</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s1">&#39;TWTR&#39;</span><span class="p">,</span> <span class="n">_latethrough</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Use <code class="docutils literal notranslate"><span class="pre">takelate</span></code> set to <code class="docutils literal notranslate"><span class="pre">True</span></code> when <em>resampling/replaying</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cerebro</span><span class="o">.</span><span class="n">resampledata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">takelate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="ibbroker-trading-live">
<h2>IBBroker - Trading Live<a class="headerlink" href="#ibbroker-trading-live" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Following a request a <code class="docutils literal notranslate"><span class="pre">tradeid</span></code> functionality was implemented in the
<em>broker simulation</em> available in <em>backtrader</em>. This allows to keep track of
trades being executed in paralled on the same asset correctly allocating
commissions to the appropriate <code class="docutils literal notranslate"><span class="pre">tradeid</span></code></p>
<p>Such notion is not supported in this live broker because commissions are
reported by the broker at times at which it would be impossible to separate
them for the different <code class="docutils literal notranslate"><span class="pre">tradeid</span></code> values.</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">tradeid</span></code> can still be specified but it makes no longer sense.</p>
</div>
<div class="section" id="using-the-broker">
<h3>Using the broker<a class="headerlink" href="#using-the-broker" title="Permalink to this headline">¶</a></h3>
<p>To use the <em>IB Broker</em>, the standard broker simulation instance created by
<em>cerebro</em> has to be replaced.</p>
<p>Using the <em>Store</em> model (preferred):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
<span class="n">ibstore</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">stores</span><span class="o">.</span><span class="n">IBStore</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span> <span class="n">clientId</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">ibstore</span><span class="o">.</span><span class="n">getbroker</span><span class="p">()</span>  <span class="c1"># or cerebro.setbroker(...)</span>
</pre></div>
</div>
<p>Using the direct approach:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">brokers</span><span class="o">.</span><span class="n">IBBroker</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7496</span><span class="p">,</span> <span class="n">clientId</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="broker-parameters">
<h3>Broker Parameters<a class="headerlink" href="#broker-parameters" title="Permalink to this headline">¶</a></h3>
<p>Be it directly or over <code class="docutils literal notranslate"><span class="pre">getbroker</span></code> the <code class="docutils literal notranslate"><span class="pre">IBBroker</span></code> broker supports no
parameters. This is because the broker is just a proxy to the a real
<em>Broker</em>. And what the real broker gives, shall not be taken away.</p>
</div>
<div class="section" id="some-restrictions">
<h3>Some restrictions<a class="headerlink" href="#some-restrictions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="cash-and-value-reporting">
<h4>Cash and Value reporting<a class="headerlink" href="#cash-and-value-reporting" title="Permalink to this headline">¶</a></h4>
<p>Where the internal <em>backtrader</em> broker simulation makes a calculation of
<code class="docutils literal notranslate"><span class="pre">value</span></code> (net liquidation value) and <code class="docutils literal notranslate"><span class="pre">cash</span></code> before calling the strategy
<code class="docutils literal notranslate"><span class="pre">next</span></code> method, the same cannot be guaranteed with a live broker.</p>
<blockquote>
<div><ul class="simple">
<li>If the values were requested, the execution of <code class="docutils literal notranslate"><span class="pre">next</span></code> could be delayed
until the answers arrive</li>
<li>The broker may not yet have calculated the values</li>
</ul>
</div></blockquote>
<p><em>backtrader</em> tells TWS to provide the updated values as soon as they are
changed (<em>backtrader</em> subscribes to <code class="docutils literal notranslate"><span class="pre">accounUpdate</span></code> messages), but it doesn’t
know when the messages will arrive.</p>
<p>The values reported by the <code class="docutils literal notranslate"><span class="pre">getcash</span></code> and <code class="docutils literal notranslate"><span class="pre">getvalue</span></code> methods of <code class="docutils literal notranslate"><span class="pre">IBBroker</span></code>
are always the latest values received from IB.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A further restriction is that the values are reported in the base
currency of the account, even if values for more currencies are
available. This is a design choise.</p>
</div>
</div>
<div class="section" id="position">
<h4>Position<a class="headerlink" href="#position" title="Permalink to this headline">¶</a></h4>
<p><em>backtrader</em> uses the <code class="docutils literal notranslate"><span class="pre">Position</span></code> (price and size) of an asset reported by
TWS. Internal calculations could be used following <em>order execution</em> and <em>order
status</em> messages, but if some of these messages were missed (sockets sometimes
lose packets) the calculations would not follow.</p>
<p>Of course if upon connecting to TWS the asset on which trades will be executed
already has an open position, the calculation of <code class="docutils literal notranslate"><span class="pre">Trades</span></code> made by the
strategy will not work as usual because of the initial offset</p>
</div>
</div>
<div class="section" id="trading-with-it">
<h3>Trading with it<a class="headerlink" href="#trading-with-it" title="Permalink to this headline">¶</a></h3>
<p>There is no change with regards to the standard usage. Just use the methods
available in the strategy (see the <code class="docutils literal notranslate"><span class="pre">Strategy</span></code> reference for a full
explanation)</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">buy</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">sell</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">close</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cancel</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="order-objects-returned">
<h3>Order objects returned<a class="headerlink" href="#order-objects-returned" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Compatible with the backtrader <code class="docutils literal notranslate"><span class="pre">Order</span></code> objects (subclass in the same
hierarchy)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="order-execution-types">
<h3>Order Execution Types<a class="headerlink" href="#order-execution-types" title="Permalink to this headline">¶</a></h3>
<p>IB supports a myriad of execution types, some of them simulated by IB and some
of them supported by the exchange itself. The decision as to which order
execution types to initially support has a motivation:</p>
<blockquote>
<div><ul>
<li><p class="first">Compatibility with the <em>broker simulation</em> available in <em>backtrader</em></p>
<p>The reasoning being that what has been back-tested is what will go in
production.</p>
</li>
</ul>
</div></blockquote>
<p>As such the order execution types are limited to the ones available in the
<em>broker simulation</em>:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Order.Market</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Order.Close</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Order.Limit</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Order.Stop</span></code> (when the <em>Stop</em> is triggered a <em>Market</em> order follows)</li>
<li><code class="docutils literal notranslate"><span class="pre">Order.StopLimit</span></code> (when the <em>Stop</em> is triggered a <em>Limit</em> order follows)</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Stop triggering is done following different strategies by
IB. <em>backtrader</em> does not modify the default setting which is <code class="docutils literal notranslate"><span class="pre">0</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">-</span> <span class="n">the</span> <span class="n">default</span> <span class="n">value</span><span class="o">.</span> <span class="n">The</span> <span class="s2">&quot;double bid/ask&quot;</span> <span class="n">method</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span>
<span class="n">orders</span> <span class="k">for</span> <span class="n">OTC</span> <span class="n">stocks</span> <span class="ow">and</span> <span class="n">US</span> <span class="n">options</span><span class="o">.</span> <span class="n">All</span> <span class="n">other</span> <span class="n">orders</span> <span class="n">will</span> <span class="n">use</span> <span class="n">the</span>
<span class="s2">&quot;last&quot;</span> <span class="n">method</span><span class="o">.</span>
</pre></div>
</div>
<p>If the user wishes to modify this, extra <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> can be supplied
to <code class="docutils literal notranslate"><span class="pre">buy</span></code> and <code class="docutils literal notranslate"><span class="pre">sell</span></code> following the IB documentation. For example
inside the <code class="docutils literal notranslate"><span class="pre">next</span></code> method of a strategy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># some logic before</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m_triggerMethod</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This has changed the policy to <code class="docutils literal notranslate"><span class="pre">2</span></code> (<em>“last” method, where stop
orders are triggered based on the last price.</em>)</p>
<p class="last">Please consult the IB API docs for any further clarification on stop triggering</p>
</div>
</div>
<div class="section" id="order-validity">
<h3>Order Validity<a class="headerlink" href="#order-validity" title="Permalink to this headline">¶</a></h3>
<p>The same validity notion available during backtesting (with <code class="docutils literal notranslate"><span class="pre">valid</span></code> to
<code class="docutils literal notranslate"><span class="pre">buy</span></code> and <code class="docutils literal notranslate"><span class="pre">sell</span></code>) is available and with the same meaning. As such, the
<code class="docutils literal notranslate"><span class="pre">valid</span></code> parameter is translated as follows for <em>IB Orders</em> for the following
values:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">None</span> <span class="pre">-&gt;</span> <span class="pre">GTC</span></code> (Good Til Cancelled)</p>
<p>Because no validity has been specified it is understood that the order must
be valid until cancelled</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">datetime/date</span></code> translates to <code class="docutils literal notranslate"><span class="pre">GTD</span></code> (Good Til Date)</p>
<p>Passing a datetime.datetime/datetime.date instance indicates the order must
be valid until a given point in time.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">timedelta(x)</span></code> translates to <code class="docutils literal notranslate"><span class="pre">GTD</span></code> (here <code class="docutils literal notranslate"><span class="pre">timedelta(x)</span> <span class="pre">!=</span> <span class="pre">timedelta()</span></code>)</p>
<p>This is interpreted as a signal to have an order be valid from <code class="docutils literal notranslate"><span class="pre">now</span></code> +
<code class="docutils literal notranslate"><span class="pre">timedelta(x)</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">float</span></code> translates to <code class="docutils literal notranslate"><span class="pre">GTD</span></code></p>
<p>If the value has been taken from the raw <em>float</em> datetime storage used by
<em>backtrader</em> the order must valid until the datetime indicated by that
<em>float</em></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">timedelta()</span> <span class="pre">or</span> <span class="pre">0</span></code> translates to <code class="docutils literal notranslate"><span class="pre">DAY</span></code></p>
<p>A value has been (instead of <code class="docutils literal notranslate"><span class="pre">None</span></code>) but is <em>Null</em> and is interpreted as
an order valid for the current <em>day</em> (session)</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="notifications">
<h3>Notifications<a class="headerlink" href="#notifications" title="Permalink to this headline">¶</a></h3>
<p>The standard <code class="docutils literal notranslate"><span class="pre">Order</span></code> status will be notified to a <em>strategy</em> over the method
<code class="docutils literal notranslate"><span class="pre">notify_order</span></code> (if overridden)</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Submitted</span></code> - the order has been sent to TWS</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Accepted</span></code> - the order has been placed</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Rejected</span></code> - order placement failed or was cancelled by the system during
its lifetime</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Partial</span></code> - a partial execution has taken place</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Completed</span></code> - the order has been fully executed</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Canceled</span></code> (or <code class="docutils literal notranslate"><span class="pre">Cancelled</span></code>)</p>
<p>This has several meanings under IB:</p>
<blockquote>
<div><ul>
<li><p class="first">Manual User Cancellation</p>
</li>
<li><p class="first">The Server/Exchange cancelled the order</p>
</li>
<li><p class="first">Order Validity expired</p>
<p>An heuristic will be applied and if an <code class="docutils literal notranslate"><span class="pre">openOrder</span></code> message has been
received from TWS with an <code class="docutils literal notranslate"><span class="pre">orderState</span></code> indicating <code class="docutils literal notranslate"><span class="pre">PendingCancel</span></code>
or <code class="docutils literal notranslate"><span class="pre">Canceled</span></code>, then the order will be marked as <code class="docutils literal notranslate"><span class="pre">Expired</span></code></p>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Expired</span></code> - See above for the explanation</p>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ibstore">
<h3>IBStore<a class="headerlink" href="#ibstore" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="ibbroker">
<h3>IBBroker<a class="headerlink" href="#ibbroker" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="ibdata">
<h3>IBData<a class="headerlink" href="#ibdata" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, 2016, 2017, 2018 Daniel Rodriguez.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>