<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Observers and Statistics &#8212; backtrader 1.9.69.122 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mycss-2016-12-25-2300.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="../_static/myjs-2016-12-25-2300.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Benchmarking" href="../observer-benchmark/benchmarking.html" />
    <link rel="prev" title="Indicator Development" href="../inddev.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

 <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <!-- <a class="navbar-brand" href="../index.html"> -->
        <a class="navbar-brand" href="/">
          backtrader</a>
        <a href="../index.html">
	  <span class="navbar-text navbar-version pull-left"><b>1.9.69.122</b></span>
	</a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav navbar-right"> 
            
                <li><a href="/">Home</a></li>
                <li><a href="/features">Features</a></li>
                <li><a href="/docu">Docs</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="https://community.backtrader.com">Community</a></li>
            
            
	      
              
            
            
            
            
            
          </ul>

          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- backtrader-001 -->
      <ins class="adsbygoogle"
	   style="display:block"
	   data-ad-client="ca-pub-2694577446631179"
	   data-ad-slot="3977998265"
	   data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<div class="globaltoc">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts.html">Platform Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operating.html">Operating the platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exceptions.html">Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cerebro.html">Cerebro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cerebro/cheat-on-open/cheat-on-open.html">Cheat On Open</a></li>
<li class="toctree-l1"><a class="reference internal" href="../strategy.html">Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sizers/sizers.html">Sizers - Smart Staking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/timers.html">Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order_target/order_target.html">Target Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../signal_strategy/signal_strategy.html">Strategy with Signals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../broker.html">Broker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../slippage/slippage.html">Slippage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filler.html">Fillers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order.html">Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/order-creation-execution.html">Order Management and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/oco/oco.html">OCO orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/trail/stoptrail.html">StopTrail(Limit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/bracket/bracket.html">Bracket Orders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../order-creation-execution/futurespot/future-vs-spot.html">Futures and Spot Compensation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed.html">Data Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed-develop-csv.html">CSV Data Feed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datafeed-develop-general/datafeed-develop-general.html">Binary Datafeed Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending-a-datafeed.html">Extending a Datafeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandas-datafeed/pandas-datafeed.html">Pandas DataFeed Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tradingcalendar/tradingcalendar.html">Trading Calendar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-resampling/data-resampling.html">Data Resampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-multitimeframe/data-multitimeframe.html">Data - Multiple Timeframes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-replay/data-replay.html">Data - Replay</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-rollover/rolling-futures-over.html">Rolling over Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../induse.html">Using Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talib/talib.html">TA-Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixing-timeframes/indicators-mixing-timeframes.html">Mixing Timeframes in Indicators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inddev.html">Indicator Development</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Observers and Statistics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#accesing-the-observers">Accesing the Observers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#observer-implementation">Observer Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-observers-to-the-strategy">Adding Observers to the Strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developing-observers">Developing Observers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-orderobserver">Custom <em>OrderObserver</em></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#saving-keeping-the-statistics">Saving/Keeping the statistics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../observer-benchmark/benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/analyzers.html">Analyzers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/pyfolio.html">PyFolio Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers/pyfolio-integration/pyfolio-integration.html">Pyfolio Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writer.html">Writer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commission-schemes/commission-schemes.html">Commissions: Stocks vs Futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending-commissions/commission-schemes-extended.html">Extending Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-defined-commissions/commission-schemes-subclassing.html">User Defined Commissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commission-credit.html">Commissions: Credit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../position.html">Position</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trade.html">Trade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/ranges/plotting-date-ranges.html">Plotting Date Ranges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/sameaxis/plot-sameaxis.html">Plotting on the same axis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization-improvements.html">Optimization improvements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../automated-bt-run/automated-bt-run.html">Automating BackTesting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../memory-savings/memory-savings.html">Saving Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timemgmt.html">DateTime Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../live/live.html">Live Data Feeds and Live Trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataautoref.html">Data Feeds Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datayahoo.html">Yahoo Data Feed Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indautoref.html">Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../talibindautoref.html">TA-Lib Indicator Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../strategy-reference.html">Strategies Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzers-reference.html">Analyzers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observers-reference.html">Observers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sizers-reference.html">Sizers Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters-reference.html">Filters Reference</a></li>
</ul>

</div>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="observers-and-statistics">
<h1>Observers and Statistics<a class="headerlink" href="#observers-and-statistics" title="Permalink to this headline">¶</a></h1>
<p>Strategies running inside the <code class="docutils literal notranslate"><span class="pre">backtrader</span></code> do mostly deal with <strong>data feeds</strong>
and <strong>indicators</strong>.</p>
<p>Data feeds are added to <strong>Cerebro</strong> instances and end up being part of the
input of strategies (parsed and served as attributes of the instance) whereas
Indicators are declared and managed by the Strategy itself.</p>
<p>All <code class="docutils literal notranslate"><span class="pre">backtrader</span></code> sample charts have so far had 3 things plotted which seem to
be taken for granted because they are not declared anywhere:</p>
<blockquote>
<div><ul class="simple">
<li>Cash and Value (what’s happening with the money in the broker)</li>
<li>Trades (aka Operations)</li>
<li>Buy/Sell Orders</li>
</ul>
</div></blockquote>
<p>They are <code class="docutils literal notranslate"><span class="pre">Observers</span></code> and exist within the submodule
<code class="docutils literal notranslate"><span class="pre">backtrader.observers</span></code>. They are there because <strong>Cerebro</strong> supports a
parameter to automatically add (or not) them to the Strategy:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">stdstats</span></code> (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</li>
</ul>
</div></blockquote>
<p>If the default is respected <strong>Cerebro</strong> executes the following equivalent user
code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="o">...</span>

<span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>  <span class="c1"># default kwarg: stdstats=True</span>

<span class="n">cerebro</span><span class="o">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">Broker</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">Trades</span><span class="p">)</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">BuySell</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s see the usual chart with those 3 default observers (even if no order is
issued and therefore no trade happens and there is no change to the cash and
portfolio value)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">backtrader.feeds</span> <span class="kn">as</span> <span class="nn">btfeeds</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">(</span><span class="n">stdstats</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">BacktraderCSVData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;../../datas/2006-day-001.txt&#39;</span><span class="p">)</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<a class=""
               data-lightbox="group-527be7f1-8af4-4b4c-b444-8e2c6fa5c03c"
               href="../_images/observers-default1.png"
               title=""
               data-title=""
               ><img src="../_images/observers-default1.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a><p>Now let’s change the value of <code class="docutils literal notranslate"><span class="pre">stdstats</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code> when creating the
<strong>Cerebro</strong> instance (can also be done when invoking <code class="docutils literal notranslate"><span class="pre">run</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">(</span><span class="n">stdstats</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The chart is different now.</p>
<a class=""
               data-lightbox="group-2f04ae9c-bda7-4488-8fd0-c42d82aabf82"
               href="../_images/observers-default-false1.png"
               title=""
               data-title=""
               ><img src="../_images/observers-default-false1.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a><div class="section" id="accesing-the-observers">
<h2>Accesing the Observers<a class="headerlink" href="#accesing-the-observers" title="Permalink to this headline">¶</a></h2>
<p>The Observers as seen above are already there in the default case and collecting
information which can be used for statistical purposes and that’s why acess to
the observers can be done through an attribute of the strategy called:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">stats</span></code></li>
</ul>
</div></blockquote>
<p>It is simply a placeholder. If we recall the addition of one of the default
<strong>Observers</strong> as laid out above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">cerebro</span><span class="o">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">backtrader</span><span class="o">.</span><span class="n">observers</span><span class="o">.</span><span class="n">Broker</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The obvious question would be how to access the <code class="docutils literal notranslate"><span class="pre">Broker</span></code> observer. Here for
example how it’s done from the <code class="docutils literal notranslate"><span class="pre">next</span></code> method of a strategy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1000.0</span><span class="p">:</span>
           <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WHITE FLAG ... I LOST TOO MUCH&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">10000000.0</span><span class="p">:</span>
           <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TIME FOR THE VIRGIN ISLANDS ....!!!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Broker</span></code> observer just like a Data, an Indicator and the Strategy itself
is also a <code class="docutils literal notranslate"><span class="pre">Lines</span></code> objects. In this case the <code class="docutils literal notranslate"><span class="pre">Broker</span></code> has 2 lines:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cash</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">value</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="observer-implementation">
<h2>Observer Implementation<a class="headerlink" href="#observer-implementation" title="Permalink to this headline">¶</a></h2>
<p>The implementation is very similar to that of an Indicator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Broker</span><span class="p">(</span><span class="n">Observer</span><span class="p">):</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;CashValue&#39;</span><span class="p">,)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cash&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

    <span class="n">plotinfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">cash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getcash</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>Steps:</p>
<blockquote>
<div><ul class="simple">
<li>Derive from <code class="docutils literal notranslate"><span class="pre">Observer</span></code> (and not from <code class="docutils literal notranslate"><span class="pre">Indicator</span></code>)</li>
<li>Declare lines and params as needed (<code class="docutils literal notranslate"><span class="pre">Broker</span></code> has 2 lines but no params)</li>
<li>There will be an automatic attribute <code class="docutils literal notranslate"><span class="pre">_owner</span></code> which is the strategy
holding the observer</li>
</ul>
</div></blockquote>
<p>Observers come in action:</p>
<blockquote>
<div><ul class="simple">
<li>After all Indicators have been calculated</li>
<li>After the Strategy <code class="docutils literal notranslate"><span class="pre">next</span></code> method has been executed</li>
<li>That means: at the end of the cycle … they <strong>observe</strong> what has happened</li>
</ul>
</div></blockquote>
<p>In the <code class="docutils literal notranslate"><span class="pre">Broker</span></code> case it’s simply blindly recording the broker cash and
portfolio values at each point in time.</p>
</div>
<div class="section" id="adding-observers-to-the-strategy">
<h2>Adding Observers to the Strategy<a class="headerlink" href="#adding-observers-to-the-strategy" title="Permalink to this headline">¶</a></h2>
<p>As already pointed out above, <strong>Cerebro</strong> is using the <code class="docutils literal notranslate"><span class="pre">stdstats</span></code> parameter to
decide whether to add 3 default <strong>Observers</strong>, alleviating the work of the end
user.</p>
<p>Adding other Observers to the mix is possible, be it along the <code class="docutils literal notranslate"><span class="pre">stdstats</span></code> or
removing those.</p>
<p>Let’s go for the usual strategy which buys when the <code class="docutils literal notranslate"><span class="pre">close</span></code> price goes above a
<code class="docutils literal notranslate"><span class="pre">SimpleMovingAverage</span></code> and sells if the opposite is true.</p>
<p>With one “addition”:</p>
<blockquote>
<div><ul class="simple">
<li><strong>DrawDown</strong> which is an already existing observer in the <code class="docutils literal notranslate"><span class="pre">backtrader</span></code>
ecosystem</li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">backtrader.feeds</span> <span class="kn">as</span> <span class="nn">btfeeds</span>
<span class="kn">import</span> <span class="nn">backtrader.indicators</span> <span class="kn">as</span> <span class="nn">btind</span>


<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;smaperiod&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
</div>
<p>The visual output shows the evolution of the drawdown</p>
<a class=""
               data-lightbox="group-b8a544e5-b7c1-4363-bbc6-2766c0827a6d"
               href="../_images/observers-default-drawdown1.png"
               title=""
               data-title=""
               ><img src="../_images/observers-default-drawdown1.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a><p>And part of the text output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.22</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.00</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.00</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.10</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.39</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.21</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.28</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.65</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">DrawDown</span><span class="p">:</span> <span class="mf">0.06</span>
<span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span><span class="n">T23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">MaxDrawDown</span><span class="p">:</span> <span class="mf">2.62</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>As seen in the text output and in the code, the <code class="docutils literal notranslate"><span class="pre">DrawDown</span></code> observer has
actually 2 lines:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">drawdown</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">maxdrawdown</span></code></li>
</ul>
</div></blockquote>
<p>The choice is not to plot the <code class="docutils literal notranslate"><span class="pre">maxdrawdown</span></code> line, but make it is still
available to the user.</p>
<p class="last">Actually the last value of <code class="docutils literal notranslate"><span class="pre">maxdrawdown</span></code> is also available in a direct
attribute (not a line) with the name of <code class="docutils literal notranslate"><span class="pre">maxdd</span></code></p>
</div>
</div>
<div class="section" id="developing-observers">
<h2>Developing Observers<a class="headerlink" href="#developing-observers" title="Permalink to this headline">¶</a></h2>
<p>The implementation of the <code class="docutils literal notranslate"><span class="pre">Broker</span></code> observer was shown above. To produce a
meaningful observer, the implementation can use the following information:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">self._owner</span></code> is the currently strategy being executed</p>
<p>As such anything within the strategy is available to the observer</p>
</li>
<li><p class="first">Default internal things available in the strategy which may be useful:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">broker</span></code> -&gt; attribute giving access to the broker instance the strategy
creates order against</p>
<p>As seen in <code class="docutils literal notranslate"><span class="pre">Broker</span></code>, cash and portfolio values are collected by invoking
the methods <code class="docutils literal notranslate"><span class="pre">getcash</span></code> and <code class="docutils literal notranslate"><span class="pre">getvalue</span></code></p>
</li>
</ul>
</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_orderspending</span></code> -&gt; list orders created by the strategy and for which the
broker has notified an event to the strategy.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BuySell</span></code> observer traverses the list looking for orders which have
executed (totally or partially) to create an average execution price for
the given point in time (index 0)</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_tradespending</span></code> -&gt; list of trades (a set of completed buy/sell or
sell/buy pairs) which is compiled from the buy/sell orders</p>
</li>
</ul>
</div></blockquote>
</div></blockquote>
<p>An <strong>Observer</strong> can obviously access other observers over the
<code class="docutils literal notranslate"><span class="pre">self._owner.stats</span></code> path.</p>
<div class="section" id="custom-orderobserver">
<h3>Custom <em>OrderObserver</em><a class="headerlink" href="#custom-orderobserver" title="Permalink to this headline">¶</a></h3>
<p>The standard <code class="docutils literal notranslate"><span class="pre">BuySell</span></code> observer does only care about operations which have
executed. We can create an observer which shows when orders where created and if
they expired.</p>
<p>For the sake of <em>visibility</em> the display will not be plotted along the price but
on a separate axis.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>


<span class="k">class</span> <span class="nc">OrderObserver</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">Observer</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;expired&#39;</span><span class="p">,)</span>

    <span class="n">plotinfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plotlinelabels</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">plotlines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">created</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">),</span>
        <span class="n">expired</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="o">.</span><span class="n">_orderspending</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="c1"># Only interested in &quot;buy&quot; orders, because the sell orders</span>
            <span class="c1"># in the strategy are Market orders and will be immediately</span>
            <span class="c1"># executed</span>

            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">created</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">price</span>

            <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Expired</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">expired</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">price</span>
</pre></div>
</div>
<p>The custom observer only cares about <strong>buy</strong> orders, because this is a strategy
which only buys to try to make a profit. Sell orders are Market orders and will
be executed immediately.</p>
<p>The Close-SMA CrossOver strategy is changed to:</p>
<blockquote>
<div><ul class="simple">
<li>Create a Limit order with a price below 1.0% the close price at the moment
of the signal</li>
<li>A validity for the order of 7 (calendar) days</li>
</ul>
</div></blockquote>
<p>The resulting chart.</p>
<a class=""
               data-lightbox="group-ba460e7a-829c-49f2-a9c6-c7afb0df84cf"
               href="../_images/observers-orderobserver1.png"
               title=""
               data-title=""
               ><img src="../_images/observers-orderobserver1.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a><p>Several orders have expired as can be seen in the new subchart (red squares) and
we can also appreciate that between “creation” and “execution” several days
happen to be.</p>
<p>Finally the code for this strategy which applies the new <strong>observer</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">backtrader.feeds</span> <span class="kn">as</span> <span class="nn">btfeeds</span>
<span class="kn">import</span> <span class="nn">backtrader.indicators</span> <span class="kn">as</span> <span class="nn">btind</span>

<span class="kn">from</span> <span class="nn">orderobserver</span> <span class="kn">import</span> <span class="n">OrderObserver</span>


<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;smaperiod&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;limitperc&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Logging function fot this strategy&#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">txt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Submitted</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">Accepted</span><span class="p">]:</span>
            <span class="c1"># Buy/Sell order submitted/accepted to/by broker - Nothing to do</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;ORDER ACCEPTED/SUBMITTED&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Expired</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY EXPIRED&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;BUY EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Sell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL EXECUTED, Price: </span><span class="si">%.2f</span><span class="s1">, Cost: </span><span class="si">%.2f</span><span class="s1">, Comm </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                          <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">comm</span><span class="p">))</span>

        <span class="c1"># Sentinel to None: new orders allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># SimpleMovingAverage on main data</span>
        <span class="c1"># Equivalent to -&gt; sma = btind.SMA(self.data, period=self.p.smaperiod)</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">btind</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">smaperiod</span><span class="p">)</span>

        <span class="c1"># CrossOver (1: up, -1: down) close / sma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buysell</span> <span class="o">=</span> <span class="n">btind</span><span class="o">.</span><span class="n">CrossOver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Sentinel to None: new ordersa allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="c1"># pending order ... do nothing</span>
            <span class="k">return</span>

        <span class="c1"># Check if we are in the market</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buysell</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;SELL CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">buysell</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plimit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">limitperc</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
                <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;BUY CREATE, </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">plimit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="n">exectype</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Limit</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">plimit</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="n">valid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runstrat</span><span class="p">():</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">BacktraderCSVData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;../../datas/2006-day-001.txt&#39;</span><span class="p">)</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">addobserver</span><span class="p">(</span><span class="n">OrderObserver</span><span class="p">)</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">MyStrategy</span><span class="p">)</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">runstrat</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-keeping-the-statistics">
<h2>Saving/Keeping the statistics<a class="headerlink" href="#saving-keeping-the-statistics" title="Permalink to this headline">¶</a></h2>
<p>As of now <code class="docutils literal notranslate"><span class="pre">backtrader</span></code> has not implemented any mechanism to track the values
of observers storing them into files. The best way to do it:</p>
<blockquote>
<div><ul class="simple">
<li>Open a file in the <code class="docutils literal notranslate"><span class="pre">start</span></code> method of the strategy</li>
<li>Write the values down in the <code class="docutils literal notranslate"><span class="pre">next</span></code> method of the strategy</li>
</ul>
</div></blockquote>
<p>Considering the <code class="docutils literal notranslate"><span class="pre">DrawDown</span></code> observer, it could be done like this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;mystats.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;datetime,drawdown, maxdrawdown</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">drawdown</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">maxdrawdown</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mystats</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To save the values of index 0, once all observers have been processed a custom
observer which writes to a file could be added as the last observer to the
system to save values to a csv file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <a class="reference internal" href="../writer.html"><span class="doc">Writer</span></a> functionality can automate this task.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, 2016, 2017, 2018 Daniel Rodriguez.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>